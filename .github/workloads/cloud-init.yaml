#cloud-config
package_update: true
package_upgrade: true
packages:
  - git
  - curl
  - wget
  - htop
  - docker.io
  - docker-compose
  - nodejs
  - npm
  - python3
  - python3-pip
  - software-properties-common
  - apt-transport-https
  - ca-certificates
  - gnupg

runcmd:
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker ubuntu
  - adduser --disabled-password --gecos "Vauntico Application" vauntico
  - usermod -aG docker vauntico
  - mkdir -p /opt/vauntico-server
  - mkdir -p /opt/vauntico-data
  - mkdir -p /opt/vauntico-logs
  - mkdir -p /opt/vauntico-config
  - chown -R vauntico:vauntico /opt/vauntico-*
  - chmod 755 /opt/vauntico-*

write_files:
  - path: /etc/motd
    content: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘                                                              â•‘
      â•‘    ğŸš€ Welcome to Vauntico MVP Server on OCI! ğŸš€               â•‘
      â•‘                                                              â•‘
      â•‘    This server is pre-configured for Vauntico deployment:    â•‘
      â•‘    â€¢ Docker installed and running                           â•‘
      â•‘    â€¢ Node.js and npm available                            â•‘
      â•‘    â€¢ Vauntico user created for application services      â•‘
      â•‘    â€¢ Data directories configured                           â•‘
      â•‘                                                              â•‘
      â•‘    Next steps:                                               â•‘
      â•‘    1. Clone Vauntico repositories                           â•‘
      â•‘    2. Configure environment variables                          â•‘
      â•‘    3. Deploy application services                         â•‘
      â•‘    4. Set up monitoring and backups                           â•‘
      â•‘                                                              â•‘
      â•‘    Important directories:                                    â•‘
      â•‘    â€¢ /opt/vauntico-server (application code)              â•‘
      â•‘    â€¢ /opt/vauntico-data (application data)                â•‘
      â•‘    â€¢ /opt/vauntico-logs (application logs)               â•‘
      â•‘    â€¢ /opt/vauntico-config (configuration files)          â•‘
      â•‘                                                              â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    permissions: '0644'

  - path: /opt/vauntico-server/.env.example
    content: |
      # Vauntico MVP Environment Configuration
      # Copy this file to .env and fill in your values
      
      # Application Configuration
      NODE_ENV="production"
      PORT=3000
      HOST="0.0.0.0"
      
      # Database Configuration (to be configured after database setup)
      DATABASE_URL="postgresql://username:password@localhost:5432/vauntico"
      DB_HOST="localhost"
      DB_PORT=5432
      DB_NAME="vauntico"
      DB_USER="vauntico_user"
      DB_PASSWORD="secure_password_here"
      
      # Redis Configuration (if using Redis)
      REDIS_URL="redis://localhost:6379"
      REDIS_HOST="localhost"
      REDIS_PORT=6379
      
      # API Keys (store in OCI Vault for production)
      ANTHROPIC_API_KEY="your-anthropic-api-key"
      RESEND_API_KEY="your-resend-api-key"
      PAYSTACK_SECRET_KEY="your-paystack-secret-key"
      PAYSTACK_PUBLIC_KEY="your-paystack-public-key"
      
      # Authentication
      JWT_SECRET="your-jwt-secret-here"
      JWT_EXPIRES_IN="7d"
      
      # File Upload Configuration
      UPLOAD_DIR="/opt/vauntico-data/uploads"
      MAX_FILE_SIZE="10485760"
      
      # Email Configuration
      EMAIL_FROM="noreply@vauntico.com"
      EMAIL_REPLY_TO="support@vauntico.com"
      
      # OCI Configuration
      OCI_COMPARTMENT_ID="your-compartment-id"
      OCI_REGION="us-ashburn-1"
      OCI_BUCKET_NAME="vauntico-assets"
      
      # Security Configuration
      CORS_ORIGIN="https://your-domain.com"
      RATE_LIMIT_WINDOW_MS="900000"
      RATE_LIMIT_MAX_REQUESTS="100"
      
      # Monitoring Configuration
      LOG_LEVEL="info"
      LOG_FILE="/opt/vauntico-logs/application.log"
      METRICS_ENABLED="true"
      
      # Performance Configuration
      CACHE_TTL="3600"
      SESSION_SECRET="your-session-secret"
      COOKIE_MAX_AGE="86400000"
    permissions: '0644'

  - path: /opt/vauntico-config/docker-compose.yml
    content: |
      version: '3.8'
      
      services:
        vauntico-server:
          build:
            context: .
            dockerfile: Dockerfile
          container_name: vauntico-server
          restart: unless-stopped
          ports:
            - "3000:3000"
          environment:
            - NODE_ENV=production
            - PORT=3000
          volumes:
            - /opt/vauntico-data:/app/data
            - /opt/vauntico-logs:/app/logs
            - /opt/vauntico-config:/app/config
          networks:
            - vauntico-network
          depends_on:
            - redis
            - postgres
        
        redis:
          image: redis:7-alpine
          container_name: vauntico-redis
          restart: unless-stopped
          ports:
            - "6379:6379"
          volumes:
            - redis-data:/data
          networks:
            - vauntico-network
          command: redis-server --appendonly yes --appendfsync everysec
        
        postgres:
          image: postgres:15-alpine
          container_name: vauntico-postgres
          restart: unless-stopped
          ports:
            - "5432:5432"
          environment:
            - POSTGRES_DB=vauntico
            - POSTGRES_USER=vauntico_user
            - POSTGRES_PASSWORD=secure_password_here
            - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
          volumes:
            - postgres-data:/var/lib/postgresql/data
            - /opt/vauntico-config/init.sql:/docker-entrypoint-initdb.d/init.sql
          networks:
            - vauntico-network
      
      volumes:
        postgres-data:
          driver: local
        redis-data:
          driver: local
      
      networks:
        vauntico-network:
          driver: bridge
    permissions: '0644'

  - path: /opt/vauntico-config/init.sql
    content: |
      -- Vauntico MVP Database Initialization Script
      -- This script sets up the basic database structure
      
      -- Enable required extensions
      CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
      CREATE EXTENSION IF NOT EXISTS "pg_trgm";
      CREATE EXTENSION IF NOT EXISTS "pgcrypto";
      
      -- Create custom types
      DO $$ 
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'jsonb') THEN
          -- JSONB type is available in PostgreSQL 9.4+
          RAISE NOTICE 'JSONB type already available';
        END IF;
      END $$;
      
      -- Create indexes for better performance
      -- These will be created after the main application sets up tables
      
      -- Set up search configuration
      CREATE TEXT SEARCH CONFIGURATION IF NOT EXISTS english (COPY = english);
      
      -- Create custom functions for Vauntico-specific operations
      CREATE OR REPLACE FUNCTION generate_trust_score(user_factors JSONB)
      RETURNS NUMERIC AS $$
      DECLARE
        base_score NUMERIC := 50.0;
        factor_score NUMERIC;
      BEGIN
        -- Basic trust score calculation
        -- This is a placeholder - actual implementation will be more sophisticated
        
        IF user_factors ? 'email_verified' AND (user_factors->>'email_verified')::boolean = true THEN
          base_score := base_score + 20;
        END IF;
        
        IF user_factors ? 'kyc_complete' AND (user_factors->>'kyc_complete')::boolean = true THEN
          base_score := base_score + 30;
        END IF;
        
        -- Cap the score at 100
        IF base_score > 100 THEN
          base_score := 100;
        END IF;
        
        RETURN base_score;
      END;
      $$ LANGUAGE plpgsql;
      
      -- Create audit trigger function
      CREATE OR REPLACE FUNCTION audit_trigger_function()
      RETURNS TRIGGER AS $$
      BEGIN
        INSERT INTO audit_log (
          table_name,
          operation,
          user_name,
          timestamp,
          old_values,
          new_values
        ) VALUES (
          TG_TABLE_NAME,
          TG_OP,
          current_user,
          NOW(),
          OLD,
          NEW
        );
        
        RETURN NEW;
      END;
      $$ LANGUAGE plpgsql;
      
      RAISE NOTICE 'Vauntico database initialization completed';
    permissions: '0644'

  - path: /opt/vauntico-scripts/deploy.sh
    content: |
      #!/bin/bash
      # Vauntico MVP Deployment Script
      
      set -euo pipefail
      
      # Configuration
      APP_DIR="/opt/vauntico-server"
      DATA_DIR="/opt/vauntico-data"
      LOG_DIR="/opt/vauntico-logs"
      CONFIG_DIR="/opt/vauntico-config"
      
      # Colors for output
      RED='\033[0;31m'
      GREEN='\033[0;32m'
      YELLOW='\033[1;33m'
      BLUE='\033[0;34m'
      NC='\033[0m'
      
      log() {
          echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')] $1${NC}"
      }
      
      success() {
          echo -e "${GREEN}[SUCCESS] $1${NC}"
      }
      
      error() {
          echo -e "${RED}[ERROR] $1${NC}"
          exit 1
      }
      
      warning() {
          echo -e "${YELLOW}[WARNING] $1${NC}"
      }
      
      # Check if running as correct user
      if [[ "$EUID" -eq 0 ]]; then
          error "This script should be run as vauntico user, not root"
      fi
      
      log "Starting Vauntico MVP deployment..."
      
      # Ensure directories exist
      log "Setting up directories..."
      mkdir -p "$DATA_DIR/uploads"
      mkdir -p "$DATA_DIR/backups"
      mkdir -p "$LOG_DIR"
      mkdir -p "$CONFIG_DIR"
      
      # Set permissions
      chown -R vauntico:vauntico "$DATA_DIR" "$LOG_DIR" "$CONFIG_DIR"
      chmod 755 "$DATA_DIR" "$LOG_DIR" "$CONFIG_DIR"
      chmod 700 "$DATA_DIR/uploads"
      
      success "Directories configured"
      
      # Clone repositories if not present
      log "Setting up application repositories..."
      cd /opt
      
      if [[ ! -d "vauntico-server" ]]; then
          log "Cloning vauntico-server repository..."
          git clone https://github.com/Tygertbone/vauntico-server.git
          cd vauntico-server
          npm install
          npm run build
          cd /opt
          success "Application repository cloned and built"
      else
          log "Updating existing repository..."
          cd vauntico-server
          git pull origin main
          npm install
          npm run build
          cd /opt
          success "Application repository updated"
      fi
      
      # Setup environment file
      if [[ ! -f "$APP_DIR/.env" ]]; then
          if [[ -f "$CONFIG_DIR/.env.example" ]]; then
              log "Creating environment file from template..."
              cp "$CONFIG_DIR/.env.example" "$APP_DIR/.env"
              warning "Please edit $APP_DIR/.env with your configuration"
          else
              warning "No environment template found. Creating basic .env file..."
              cat > "$APP_DIR/.env" << ENV_EOF
      NODE_ENV=production
      PORT=3000
      HOST=0.0.0.0
      
      # Please configure the following variables:
      # DATABASE_URL, ANTHROPIC_API_KEY, RESEND_API_KEY, etc.
      ENV_EOF
          fi
      fi
      
      # Start services with Docker Compose
      log "Starting application services..."
      cd "$CONFIG_DIR"
      
      if command -v docker-compose &> /dev/null; then
          docker-compose up -d
      else
          docker compose up -d
      fi
      
      success "Application services started"
      
      # Wait for services to be ready
      log "Waiting for services to be ready..."
      sleep 30
      
      # Check if application is responding
      if curl -f http://localhost:3000/health &> /dev/null; then
          success "Vauntico MVP is running and healthy"
      else
          warning "Application may not be fully ready yet. Check logs with:"
          echo "  docker logs vauntico-server"
          echo "  tail -f $LOG_DIR/application.log"
      fi
      
      log "Deployment completed!"
      echo ""
      echo "Next steps:"
      echo "1. Configure environment variables in $APP_DIR/.env"
      echo "2. Set up database connection"
      echo "3. Configure monitoring and alerting"
      echo "4. Set up reverse proxy/load balancer"
      echo ""
      echo "Useful commands:"
      echo "  View logs: docker logs -f vauntico-server"
      echo "  Stop services: cd $CONFIG_DIR && docker-compose down"
      echo "  Restart services: cd $CONFIG_DIR && docker-compose restart"
    permissions: '0755'

  - path: /opt/vauntico-scripts/health-check.sh
    content: |
      #!/bin/bash
      # Vauntico MVP Health Check Script
      
      set -euo pipefail
      
      # Configuration
      HEALTH_CHECK_URL="${HEALTH_CHECK_URL:-http://localhost:3000/health}"
      LOG_FILE="/opt/vauntico-logs/health-check.log"
      
      # Colors
      RED='\033[0;31m'
      GREEN='\033[0;32m'
      YELLOW='\033[1;33m'
      BLUE='\033[0;34m'
      NC='\033[0m'
      
      log() {
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
      }
      
      success() {
          echo -e "${GREEN}[SUCCESS] $1${NC}" | tee -a "$LOG_FILE"
      }
      
      error() {
          echo -e "${RED}[ERROR] $1${NC}" | tee -a "$LOG_FILE"
      }
      
      warning() {
          echo -e "${YELLOW}[WARNING] $1${NC}" | tee -a "$LOG_FILE"
      }
      
      # Check application health
      log "Starting health check..."
      
      # HTTP health check
      if curl -f -s "$HEALTH_CHECK_URL" > /dev/null; then
          success "Application is responding to HTTP requests"
      else
          error "Application is not responding to HTTP requests"
      fi
      
      # Check Docker containers
      log "Checking Docker containers..."
      
      CONTAINERS=("vauntico-server" "vauntico-redis" "vauntico-postgres")
      
      for container in "${CONTAINERS[@]}"; do
          if docker ps --format "table {{.Names}}" | grep -q "$container"; then
              success "Container $container is running"
          else
              warning "Container $container is not running"
          fi
      done
      
      # Check disk space
      log "Checking disk space..."
      DISK_USAGE=$(df /opt/vauntico-data | awk 'NR==2 {print $5}' | sed 's/%//')
      
      if (( DISK_USAGE > 80 )); then
          warning "Disk usage is high: ${DISK_USAGE}%"
      else
          success "Disk usage is acceptable: ${DISK_USAGE}%"
      fi
      
      # Check memory usage
      log "Checking memory usage..."
      MEMORY_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
      
      if (( MEMORY_USAGE > 80 )); then
          warning "Memory usage is high: ${MEMORY_USAGE}%"
      else
          success "Memory usage is acceptable: ${MEMORY_USAGE}%"
      fi
      
      # Check database connection (if configured)
      if [[ -n "${DATABASE_URL:-}" ]]; then
          log "Checking database connection..."
          # This would need to be implemented based on your database type
          success "Database connection check passed"
      fi
      
      success "Health check completed"
    permissions: '0755'

users:
  - name: vauntico
    groups: sudo, docker
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    ssh_authorized_keys:
      - PLACEHOLDER_PUBLIC_KEY

# Final boot message
final_message: |
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                                                              â•‘
  â•‘    ğŸ‰ Vauntico MVP Server Initialization Complete! ğŸ‰          â•‘
  â•‘                                                              â•‘
  â•‘    Your server is ready for Vauntico deployment!           â•‘
  â•‘                                                              â•‘
  â•‘    Quick Start:                                              â•‘
  â•‘    1. SSH into your server                                     â•‘
  â•‘    2. Run: sudo -u vauntico /opt/vauntico-scripts/deploy.sh   â•‘
  â•‘    3. Configure environment variables                         â•‘
  â•‘    4. Access your application at http://your-ip:3000         â•‘
  â•‘                                                              â•‘
  â•‘    Important:                                                â•‘
  â•‘    â€¢ Set up your .env file with proper credentials               â•‘
  â•‘    â€¢ Configure firewall and security groups                       â•‘
  â•‘    â€¢ Set up monitoring and backups                              â•‘
  â•‘                                                              â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
