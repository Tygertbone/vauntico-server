name: Semantic Release - Enterprise Grade

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      version:
        description: "Override version (semantic)"
        required: false
        default: ""
      dry_run:
        description: "Dry run (don't actually release)"
        required: false
        default: false
        type: boolean
      force:
        description: "Force release even if no changes"
        required: false
        default: false
        type: boolean

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
  GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
  SLACK_WEBHOOK: ${{ secrets.SLACK_RELEASE_WEBHOOK }}

jobs:
  pre-release-checks:
    name: Pre-release Validation
    runs-on: ubuntu-latest
    outputs:
      can-release: ${{ steps.check.outputs.can-release }}
      release-type: ${{ steps.check.outputs.release-type }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check commit messages for semantic compliance
        id: check
        run: |
          echo "ðŸ” Analyzing commits for semantic release..."

          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log $LAST_TAG..HEAD --oneline --format="%s")
          else
            COMMITS=$(git log --oneline --format="%s")
          fi

          echo "Commits to analyze:"
          echo "$COMMITS"

          # Check for release-triggering commits
          if echo "$COMMITS" | grep -E "^(feat|fix|perf|refactor|docs|style|test|chore|build|ci|revert)(\(.+\))?!?:"; then
            echo "âœ… Found release-triggering commits"
            
            # Determine release type
            if echo "$COMMITS" | grep -E "^(feat|BREAKING CHANGE)" | grep -q "!"; then
              echo "release-type=major" >> $GITHUB_OUTPUT
              echo "version=$(echo "$COMMITS" | grep -E "^(feat|BREAKING CHANGE)" | head -1 | cut -d':' -f1 | sed 's/.*!.*->/->/' | cut -d'>' -f2)" >> $GITHUB_OUTPUT
            elif echo "$COMMITS" | grep -E "^(feat|BREAKING CHANGE)"; then
              echo "release-type=minor" >> $GITHUB_OUTPUT
            else
              echo "release-type=patch" >> $GITHUB_OUTPUT
            fi
            
            echo "can-release=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No release-triggering commits found"
            echo "can-release=false" >> $GITHUB_OUTPUT
          fi

          # Override with manual input if provided
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "can-release=true" >> $GITHUB_OUTPUT
          fi

          # Force release if requested
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            echo "can-release=true" >> $GITHUB_OUTPUT
            echo "ðŸ”’ Force release enabled"
          fi

      - name: Check branch permissions
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "âœ… Main branch - full release allowed"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "âœ… Develop branch - pre-release allowed"
          else
            echo "âŒ Branch not authorized for releases"
            exit 1
          fi

      - name: Validate SDK builds
        run: |
          echo "ðŸ” Validating SDK builds..."

          # Check TypeScript SDK
          if [ -d "sdk/typescript" ]; then
            cd sdk/typescript
            if npm install --silent && npm run build; then
              echo "âœ… TypeScript SDK builds successfully"
            else
              echo "âŒ TypeScript SDK build failed"
              exit 1
            fi
            cd ../..
          fi

          # Check Python SDK
          if [ -d "sdk/python" ]; then
            cd sdk/python
            if pip install -e . --quiet; then
              echo "âœ… Python SDK installs successfully"
            else
              echo "âŒ Python SDK installation failed"
              exit 1
            fi
            cd ../..
          fi

  build-release-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: pre-release-checks
    if: needs.pre-release-checks.outputs.can-release == 'true'
    outputs:
      artifacts-ready: ${{ steps.build.outputs.ready }}
      release-version: ${{ steps.build.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "sdk/typescript/package-lock.json"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "sdk/python/pyproject.toml"

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Build TypeScript SDK
        run: |
          cd sdk/typescript
          npm ci --ignore-scripts
          npm run build
          npm pack --pack-destination ../../dist
          echo "âœ… TypeScript SDK artifacts built"

      - name: Build Python SDK
        run: |
          cd sdk/python
          pip install --upgrade pip setuptools wheel build
          python -m build --sdist --wheel --outdir ../../dist
          echo "âœ… Python SDK artifacts built"

      - name: Sign artifacts
        run: |
          cd dist
          for file in *.tgz *.whl *.tar.gz; do
            if [ -f "$file" ]; then
              gpg --detach-sign --armor --output "$file.asc" "$file"
              echo "âœ… Signed: $file"
            fi
          done

      - name: Create source archive
        run: |
          git archive --format=tar.gz --prefix=vauntico-sdk-${{ needs.pre-release-checks.outputs.version }}/ HEAD > dist/vauntico-sdk-${{ needs.pre-release-checks.outputs.version }}.tar.gz
          gpg --detach-sign --armor --output dist/vauntico-sdk-${{ needs.pre-release-checks.outputs.version }}.tar.gz.asc dist/vauntico-sdk-${{ needs.pre-release-checks.outputs.version }}.tar.gz
          echo "âœ… Source archive created"

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          sha512sum * > checksums-sha512.txt
          echo "âœ… Checksums generated"

      - name: Upload artifacts
        id: build
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            dist/
            CHANGELOG.md
          retention-days: 90
        continue-on-error: false

      - name: Set outputs
        run: |
          echo "ready=true" >> $GITHUB_OUTPUT
          echo "version=${{ needs.pre-release-checks.outputs.version }}" >> $GITHUB_OUTPUT

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [pre-release-checks, build-release-artifacts]
    if: |
      needs.pre-release-checks.outputs.can-release == 'true' && 
      needs.build-release-artifacts.outputs.artifacts-ready == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist/

      - name: Generate release notes
        id: notes
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log $LAST_TAG..HEAD --oneline --format="* %s (%h)" | head -20)
          else
            COMMITS=$(git log --oneline --format="* %s (%h)" | head -20)
          fi

          # Generate release notes
          cat > release_notes.md << EOF
          # ðŸš€ Vauntico SDK ${{ needs.pre-release-checks.outputs.version }}

          ## ðŸ“‹ What's Changed

          $COMMITS

          ## ðŸ“¦ Installation

          ### TypeScript
          \`\`\`bash
          npm install @vauntico/sdk@${{ needs.pre-release-checks.outputs.version }}
          \`\`\`

          ### Python
          \`\`\`bash
          pip install vauntico-sdk==${{ needs.pre-release-checks.outputs.version }}
          \`\`\`

          ## ðŸ“š Documentation

          - [API Documentation](https://docs.vauntico.com/api)
          - [GitHub Repository](https://github.com/Tygertbone/vauntico-server)
          - [Changelog](https://github.com/Tygertbone/vauntico-server/blob/main/CHANGELOG.md)

          ## ðŸ” Verification

          All artifacts are signed with GPG. Verify with:
          \`\`\`bash
          gpg --verify artifact.asc artifact
          \`\`\`

          EOF

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const releaseNotes = `${{ steps.notes.outputs.notes }}`;
            const version = '${{ needs.pre-release-checks.outputs.version }}';
            const isPrerelease = '${{ github.ref }}' !== 'refs/heads/main';

            // List all artifacts
            const distPath = 'dist';
            const artifacts = fs.readdirSync(distPath).filter(f => 
              !f.endsWith('.asc') && f !== 'checksums.txt' && f !== 'checksums-sha512.txt'
            );

            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${version}`,
              name: `ðŸš€ Vauntico SDK ${version}`,
              body: releaseNotes,
              draft: false,
              prerelease: isPrerelease,
              generate_release_notes: false
            });

            // Upload assets
            for (const artifact of artifacts) {
              const filePath = path.join(distPath, artifact);
              const fileStats = fs.statSync(filePath);
              
              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id,
                name: artifact,
                data: fs.readFileSync(filePath),
                headers: {
                  'content-type': 'application/octet-stream',
                  'content-length': fileStats.size
                }
              });
              
              console.log(`âœ… Uploaded: ${artifact}`);
            }

            // Upload checksums and signatures
            const checksumFiles = ['checksums.txt', 'checksums-sha512.txt'];
            for (const checksumFile of checksumFiles) {
              const filePath = path.join(distPath, checksumFile);
              if (fs.existsSync(filePath)) {
                const fileStats = fs.statSync(filePath);
                
                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.data.id,
                  name: checksumFile,
                  data: fs.readFileSync(filePath),
                  headers: {
                    'content-type': 'text/plain',
                    'content-length': fileStats.size
                  }
                });
              }
            }

            // Upload signatures
            for (const artifact of artifacts) {
              const sigFile = `${artifact}.asc`;
              const sigPath = path.join(distPath, sigFile);
              
              if (fs.existsSync(sigPath)) {
                const fileStats = fs.statSync(sigPath);
                
                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.data.id,
                  name: sigFile,
                  data: fs.readFileSync(sigPath),
                  headers: {
                    'content-type': 'application/pgp-signature',
                    'content-length': fileStats.size
                  }
                });
                
                console.log(`âœ… Uploaded signature: ${sigFile}`);
              }
            }

            console.log(`ðŸŽ‰ Release created: v${version}`);

  trigger-publish-workflows:
    name: Trigger Publishing Workflows
    runs-on: ubuntu-latest
    needs: [pre-release-checks, create-github-release]
    if: |
      needs.pre-release-checks.outputs.can-release == 'true' && 
      needs.create-github-release.result == 'success'
    strategy:
      matrix:
        sdk: [typescript, python]
      fail-fast: false
    steps:
      - name: Trigger ${{ matrix.sdk }} publish workflow
        uses: actions/github-script@v7
        with:
          script: |
            const sdk = '${{ matrix.sdk }}';
            const workflow = sdk === 'typescript' ? 'npm-publish.yml' : 'pypi-publish.yml';

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflow,
                ref: 'main',
                inputs: {
                  version: '${{ needs.pre-release-checks.outputs.version }}',
                  dry_run: '${{ github.event.inputs.dry_run || 'false' }}'
                }
              });
              
              console.log(`âœ… Triggered ${sdk} publish workflow`);
            } catch (error) {
              console.error(`âŒ Failed to trigger ${sdk} publish workflow:`, error);
              // Don't fail the job, just log the error
            }

  notify-teams:
    name: Notify Teams
    runs-on: ubuntu-latest
    needs:
      [pre-release-checks, create-github-release, trigger-publish-workflows]
    if: always()
    steps:
      - name: Slack notification
        if: env.SLACK_WEBHOOK != ''
        run: |
          VERSION="${{ needs.pre-release-checks.outputs.version }}"
          STATUS="${{ needs.create-github-release.result }}"

          if [ "$STATUS" = "success" ]; then
            COLOR="good"
            EMOJI="ðŸŽ‰"
            MESSAGE="Successfully released Vauntico SDK v$VERSION"
          else
            COLOR="danger"
            EMOJI="âŒ"
            MESSAGE="Failed to release Vauntico SDK v$VERSION"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$EMOJI Vauntico SDK Release\",
                \"title_link\": \"https://github.com/Tygertbone/vauntico-server/releases\",
                \"text\": \"$MESSAGE\",
                \"fields\": [
                  {\"title\": \"Version\", \"value\": \"v$VERSION\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true}
                ]
              }]
            }" \
            "$SLACK_WEBHOOK"

      - name: Create release issue for tracking
        if: needs.create-github-release.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.pre-release-checks.outputs.version }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš€ Release v${version} Completed`,
              body: `
              ## Release Summary
              
              **Version**: v${version}
              **Status**: âœ… Successful
              **Branch**: ${context.ref_name}
              **Commit**: ${context.sha}
              
              ### Artifacts Published:
              - [GitHub Release](https://github.com/Tygertbone/vauntico-server/releases/tag/v${version})
              - [TypeScript SDK](https://www.npmjs.com/package/@vauntico/sdk)
              - [Python SDK](https://pypi.org/project/vauntico-sdk/)
              
              ### Next Steps:
              1. Monitor publishing workflows
              2. Verify package availability
              3. Update documentation if needed
              4. Announce to users
              
              **Timeline**: ðŸ“… Completed
              **Priority**: âœ… Normal
              `,
              labels: ['release', 'completed', 'automated']
            });

  rollback-strategy:
    name: Rollback Strategy
    runs-on: ubuntu-latest
    needs: [create-github-release]
    if: failure() && github.ref == 'refs/heads/main'
    steps:
      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.pre-release-checks.outputs.version }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Rollback Required - Release v${version} Failed`,
              body: `
              ## Immediate Rollback Required
              
              The release workflow failed for v${version}.
              
              ### Critical Actions Required:
              1. **STOP**: Halt any ongoing publishing processes
              2. **INVESTIGATE**: Check workflow logs for failure point
              3. **ROLLBACK**: Remove any published artifacts
              4. **FIX**: Address the root cause
              5. **RETRY**: Attempt release again after fixes
              
              ### Rollback Commands:
              \`\`\`bash
              # Delete GitHub release
              gh release delete v${version}
              
              # Delete tag
              git tag -d v${version}
              git push origin :refs/tags/v${version}
              
              # Unpublish npm package (if published)
              npm unpublish @vauntico/sdk@${version} --force
              
              # Yank PyPI package (if published)
              twine yank vauntico-sdk==${version}
              \`\`\`
              
              ### Affected Systems:
              - GitHub Releases
              - npm registry
              - PyPI registry
              - User installations
              
              **Priority**: ðŸš¨ CRITICAL
              **Timeline**: IMMEDIATE
              **Impact**: HIGH - All users
              `,
              labels: ['critical', 'rollback', 'release-failure'],
              assignees: ['maintainer-team']
            });

  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs:
      [pre-release-checks, create-github-release, trigger-publish-workflows]
    if: always()
    steps:
      - name: Generate summary
        run: |
          VERSION="${{ needs.pre-release-checks.outputs.version }}"

          echo "## ðŸš€ Semantic Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Pre-release checks
          if [ "${{ needs.pre-release-checks.result }}" = "success" ]; then
            echo "âœ… Pre-release Checks: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Pre-release Checks: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # GitHub release
          if [ "${{ needs.create-github-release.result }}" = "success" ]; then
            echo "âœ… GitHub Release: Created" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ GitHub Release: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Publishing workflows
          if [ "${{ needs.trigger-publish-workflows.result }}" = "success" ]; then
            echo "âœ… Publishing Workflows: Triggered" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Publishing Workflows: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/Tygertbone/vauntico-server/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [npm Package](https://www.npmjs.com/package/@vauntico/sdk)" >> $GITHUB_STEP_SUMMARY
          echo "- [PyPI Package](https://pypi.org/project/vauntico-sdk/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Documentation](https://docs.vauntico.com/api)" >> $GITHUB_STEP_SUMMARY
