name: npm Publish - Enterprise Grade

on:
  push:
    branches: [main, alpha, beta, rc]
    paths:
      - "sdk/typescript/**"
      - ".github/workflows/npm-publish.yml"
      - ".releaserc.json"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (semantic)"
        required: false
        default: ""
      dry_run:
        description: "Dry run (do not actually publish)"
        required: false
        default: false
        type: boolean
      registry:
        description: "Registry to publish to"
        required: false
        default: "npm"
        type: choice
        options:
          - npm
          - github
          - both

env:
  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
  GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

jobs:
  security-scan:
    name: Security & Dependency Audit
    runs-on: ubuntu-latest
    outputs:
      security-passed: ${{ steps.security.outputs.passed }}
      audit-passed: ${{ steps.audit.outputs.passed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "sdk/typescript/package-lock.json"

      - name: Install dependencies
        run: |
          cd sdk/typescript
          npm ci --ignore-scripts

      - name: Run npm audit
        id: audit
        run: |
          cd sdk/typescript
          if npm audit --audit-level=moderate --production; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… npm audit passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ npm audit found issues"
            exit 1
          fi

      - name: Run security scan with Snyk
        id: security
        run: |
          cd sdk/typescript
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "âœ… Security scan completed"

      - name: Check for known vulnerabilities
        run: |
          cd sdk/typescript
          npx audit-ci --moderate

  test-coverage:
    name: Test Coverage Gate (80%+)
    runs-on: ubuntu-latest
    outputs:
      coverage-passed: ${{ steps.coverage.outputs.passed }}
      coverage-percentage: ${{ steps.coverage.percentage }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "sdk/typescript/package-lock.json"

      - name: Install dependencies
        run: |
          cd sdk/typescript
          npm ci --ignore-scripts

      - name: Run tests with coverage
        id: coverage
        run: |
          cd sdk/typescript
          npm test -- --coverage --coverageReporters=json-summary --coverageReporters=text

          # Extract coverage percentage
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT

          # Check if coverage meets threshold
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Test coverage ${COVERAGE}% meets 80% threshold"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Test coverage ${COVERAGE}% below 80% threshold"
            exit 1
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./sdk/typescript/coverage/lcov.info
          flags: typescript-sdk
          name: typescript-sdk-coverage

  build-and-sign:
    name: Build & GPG Sign Package
    runs-on: ubuntu-latest
    needs: [security-scan, test-coverage]
    if: needs.security-scan.outputs.security-passed == 'true' && needs.test-coverage.outputs.coverage-passed == 'true'
    outputs:
      build-passed: ${{ steps.build.outputs.passed }}
      package-path: ${{ steps.build.outputs.package-path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "sdk/typescript/package-lock.json"

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Install dependencies
        run: |
          cd sdk/typescript
          npm ci --ignore-scripts

      - name: Build package
        id: build
        run: |
          cd sdk/typescript
          npm run build
          npm pack --pack-destination ../../dist

          PACKAGE_PATH=$(ls ../../dist/@vauntico-sdk-*.tgz)
          echo "package-path=$PACKAGE_PATH" >> $GITHUB_OUTPUT
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "âœ… Package built successfully: $PACKAGE_PATH"

      - name: Sign package with GPG
        run: |
          cd dist
          PACKAGE=$(ls @vauntico-sdk-*.tgz)
          gpg --detach-sign --armor --output "$PACKAGE.asc" "$PACKAGE"
          echo "âœ… Package signed: $PACKAGE.asc"

      - name: Verify signature
        run: |
          cd dist
          PACKAGE=$(ls @vauntico-sdk-*.tgz)
          gpg --verify "$PACKAGE.asc" "$PACKAGE"
          echo "âœ… Signature verified"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: npm-package
          path: |
            dist/*.tgz
            dist/*.asc
          retention-days: 30

  multi-registry-publish:
    name: Multi-Registry Publishing
    runs-on: ubuntu-latest
    needs: [build-and-sign]
    if: needs.build-and-sign.outputs.build-passed == 'true'
    strategy:
      matrix:
        registry: [npm, github]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: npm-package
          path: dist/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: ${{ matrix.registry == 'npm' && 'https://registry.npmjs.org/' || 'https://npm.pkg.github.com/' }}
          scope: "@vauntico"

      - name: Configure .npmrc
        run: |
          if [ "${{ matrix.registry }}" = "npm" ]; then
            echo "//registry.npmjs.org/:_authToken=\${NODE_AUTH_TOKEN}" > .npmrc
            echo "registry=https://registry.npmjs.org/" >> .npmrc
          else
            echo "//npm.pkg.github.com/:_authToken=\${GITHUB_TOKEN}" > .npmrc
            echo "@vauntico:registry=https://npm.pkg.github.com/" >> .npmrc
          fi

      - name: Publish to ${{ matrix.registry }}
        id: publish
        run: |
          PACKAGE=$(ls dist/@vauntico-sdk-*.tgz)

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ðŸ” Dry run: Would publish $PACKAGE to ${{ matrix.registry }}"
            echo "published=false" >> $GITHUB_OUTPUT
          else
            if npm publish $PACKAGE --access public; then
              echo "âœ… Published to ${{ matrix.registry }}"
              echo "published=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Failed to publish to ${{ matrix.registry }}"
              echo "published=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify package availability
        if: steps.publish.outputs.published == 'true'
        run: |
          if [ "${{ matrix.registry }}" = "npm" ]; then
            npm view @vauntico/sdk
          else
            curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 https://npm.pkg.github.com/@vauntico/sdk
          fi

  pre-release-check:
    name: Pre-release Validation
    runs-on: ubuntu-latest
    needs: [multi-registry-publish]
    if: github.ref != 'refs/heads/main'
    steps:
      - name: Check branch and set pre-release label
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/alpha" ]]; then
            echo "RELEASE_CHANNEL=alpha" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/beta" ]]; then
            echo "RELEASE_CHANNEL=beta" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/rc" ]]; then
            echo "RELEASE_CHANNEL=rc" >> $GITHUB_ENV
          fi

      - name: Create pre-release tag
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const branch = context.ref.replace('refs/heads/', '');
            const version = require('./sdk/typescript/package.json').version;
            const tag = `v${version}-${process.env.RELEASE_CHANNEL || 'alpha'}`;

            await github.rest.git.createRef({
              owner,
              repo,
              ref: `refs/tags/${tag}`,
              sha: context.sha
            });

  rollback-strategy:
    name: Rollback Strategy
    runs-on: ubuntu-latest
    needs: [multi-registry-publish]
    if: failure() && github.ref == 'refs/heads/main'
    steps:
      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            await github.rest.issues.create({
              owner,
              repo,
              title: `ðŸš¨ Rollback Required - npm Publish Failed`,
              body: `
              ## Rollback Required

              The npm publish workflow failed for commit ${context.sha}.
              
              ### Immediate Actions Required:
              1. **Investigate Failure**: Check the workflow logs for the root cause
              2. **Manual Rollback**: If a partial publish occurred, unpublish the version
              3. **Fix Issues**: Address the problems that caused the failure
              4. **Redeploy**: Run the workflow again after fixes
              
              ### Rollback Commands:
              \`\`\`bash
              # Unpublish if needed
              npm unpublish @vauntico/sdk@version --force
              
              # Check current published versions
              npm view @vauntico/sdk versions --json
              \`\`\`
              
              ### Affected Components:
              - TypeScript SDK package
              - npm registry
              - GitHub Packages (if applicable)
              
              **Priority**: ðŸš¨ Critical
              **Timeline**: Immediate
              `,
              labels: ['critical', 'rollback', 'npm-publish'],
              assignees: ['maintainer-team']
            });

      - name: Notify team
        run: |
          echo "ðŸš¨ ROLLBACK NOTIFICATION:"
          echo "npm publish workflow failed on main branch"
          echo "Please check the rollback issue for immediate actions"

  publish-summary:
    name: Publish Summary
    runs-on: ubuntu-latest
    needs: [security-scan, test-coverage, multi-registry-publish]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ npm Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Security results
          if [ "${{ needs.security-scan.outputs.security-passed }}" == "true" ]; then
            echo "âœ… Security Scan: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Security Scan: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.security-scan.outputs.audit-passed }}" == "true" ]; then
            echo "âœ… npm Audit: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ npm Audit: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Coverage results
          if [ "${{ needs.test-coverage.outputs.coverage-passed }}" == "true" ]; then
            echo "âœ… Test Coverage: ${{ needs.test-coverage.outputs.coverage-percentage }}%" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Test Coverage: ${{ needs.test-coverage.outputs.coverage-percentage }}% (below 80%)" >> $GITHUB_STEP_SUMMARY
          fi

          # Publish results
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Publishing Results:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.multi-registry-publish.result }}" == "success" ]; then
            echo "âœ… Publishing: Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Publishing: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [npm Package](https://www.npmjs.com/package/@vauntico/sdk)" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Packages](https://github.com/Tygertbone/vauntico-server/packages)" >> $GITHUB_STEP_SUMMARY
          echo "- [Documentation](https://docs.vauntico.com/api)" >> $GITHUB_STEP_SUMMARY
