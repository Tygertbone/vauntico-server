name: OpenAPI Lint and Validation

on:
  push:
    branches: [main, develop]
    paths:
      - "server-v2/src/docs/openapi.yaml"
      - "server-v2/src/docs/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "server-v2/src/docs/openapi.yaml"
      - "server-v2/src/docs/**"

jobs:
  lint-openapi:
    name: Lint OpenAPI Specification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        working-directory: server-v2
        run: |
          npm ci

      - name: Install OpenAPI linter
        run: |
          npm install -g @apidevtools/swagger-parser@^10.1.0
          npm install -g @redocly/cli@^1.0.0
          npm install -g spectral@^6.0.0

      - name: Validate OpenAPI syntax
        working-directory: server-v2
        run: |
          echo "üîç Validating OpenAPI YAML syntax..."

          # Check if YAML is valid
          if ! command -v yaml lint &> /dev/null; then
            echo "Installing yaml lint..."
            npm install -g yaml-lint
          fi

          # Validate YAML syntax
          yaml lint src/docs/openapi.yaml
          if [ $? -ne 0 ]; then
            echo "‚ùå YAML syntax validation failed"
            exit 1
          fi

          echo "‚úÖ YAML syntax is valid"

      - name: Parse and validate OpenAPI structure
        working-directory: server-v2
        run: |
          echo "üîç Parsing and validating OpenAPI structure..."

          # Validate with swagger-parser
          echo "Validating with swagger-parser..."
          node -e "
            const fs = require('fs');
            const yaml = require('js-yaml');
            const SwaggerParser = require('@apidevtools/swagger-parser');
            
            try {
              const apiSpec = yaml.load(fs.readFileSync('src/docs/openapi.yaml', 'utf8'));
              console.log('üìÑ Loaded OpenAPI specification');
              
              SwaggerParser.validate(apiSpec, (err, api, metadata) => {
                if (err) {
                  console.error('‚ùå OpenAPI validation errors:', err);
                  process.exit(1);
                } else {
                  console.log('‚úÖ OpenAPI specification is valid');
                  console.log(\`üìä API Info: \${api.info?.title || 'Unknown'} v\${api.info?.version || 'Unknown'}\`);
                  
                  if (api.paths) {
                    const pathCount = Object.keys(api.paths).length;
                    console.log(\`üõ£Ô∏è Paths found: \${pathCount}\`);
                  }
                  
                  if (api.components?.schemas) {
                    const schemaCount = Object.keys(api.components.schemas).length;
                    console.log(\`üìã Schemas found: \${schemaCount}\`);
                  }
                }
              });
            } catch (error) {
              console.error('‚ùå Failed to parse OpenAPI spec:', error.message);
              process.exit(1);
            }
          "

      - name: Spectral linting
        working-directory: server-v2
        run: |
          echo "üîç Running Spectral linting..."

          # Create spectral config
          cat > .spectral.yml << 'EOF'
          extends: spectral:oas
          rules:
            # Ensure proper API structure
            no-unused-components: error
            no-ambiguous-paths: error
            no-unresolved-refs: error
            # Security rules
            security-defined: error
            no-empty-security-schemes: error
            # Data rules
            no-enum-type-mismatch: error
            no-invalid-schema-example: error
            # Documentation rules
            info-contact: warn
            info-description: warn
            operation-description: warn
            # Response rules
            no-undefined-server-variable: error
            no-unsupported-media-type: error
          EOF

          # Run spectral linting
          spectral lint src/docs/openapi.yaml --ruleset .spectral.yml || true
          if [ $? -ne 0 ]; then
            echo "‚ùå Spectral linting failed"
            exit 1
          fi

          echo "‚úÖ Spectral linting passed"

      - name: Generate documentation stats
        working-directory: server-v2
        run: |
          echo "üìä Generating documentation statistics..."

          node -e "
            const fs = require('fs');
            const yaml = require('js-yaml');
            
            try {
              const apiSpec = yaml.load(fs.readFileSync('src/docs/openapi.yaml', 'utf8'));
              
              console.log('üìà === VAUNTICO API DOCUMENTATION STATS ===');
              
              // Basic info
              if (apiSpec.info) {
                console.log(\`üìã Title: \${apiSpec.info.title || 'N/A'}\`);
                console.log(\`üìã Version: \${apiSpec.info.version || 'N/A'}\`);
                console.log(\`üìã Description: \${apiSpec.info.description ? apiSpec.info.description.substring(0, 100) + '...' : 'N/A'}\`);
              }
              
              // Servers
              if (apiSpec.servers) {
                console.log(\`üåê Servers: \${apiSpec.servers.length}\`);
                apiSpec.servers.forEach((server, i) => {
                  console.log(\`  \${i + 1}. \${server.description || server.url}\`);
                });
              }
              
              // Paths
              if (apiSpec.paths) {
                const paths = Object.keys(apiSpec.paths);
                console.log(\`üõ£Ô∏è Total Paths: \${paths.length}\`);
                
                // Count by method
                const methodCounts = {};
                paths.forEach(path => {
                  const pathItem = apiSpec.paths[path];
                  Object.keys(pathItem).forEach(method => {
                    methodCounts[method] = (methodCounts[method] || 0) + 1;
                  });
                });
                
                console.log('üìä Methods:');
                Object.entries(methodCounts).forEach(([method, count]) => {
                  console.log(\`  \${method.toUpperCase()}: \${count}\`);
                });
              }
              
              // Components
              if (apiSpec.components) {
                console.log('üß© Components:');
                
                if (apiSpec.components.schemas) {
                  const schemas = Object.keys(apiSpec.components.schemas);
                  console.log(\`  üìã Schemas: \${schemas.length}\`);
                }
                
                if (apiSpec.components.responses) {
                  const responses = Object.keys(apiSpec.components.responses);
                  console.log(\`  üì§ Responses: \${responses.length}\`);
                }
                
                if (apiSpec.components.securitySchemes) {
                  const schemes = Object.keys(apiSpec.components.securitySchemes);
                  console.log(\`  üîê Security Schemes: \${schemes.length}\`);
                }
              }
              
              // Tags
              if (apiSpec.tags) {
                console.log(\`üè∑Ô∏è Tags: \${apiSpec.tags.length}\`);
                apiSpec.tags.forEach((tag, i) => {
                  console.log(\`  \${i + 1}. \${tag.name}\`);
                });
              }
              
              console.log('=====================================');
              
            } catch (error) {
              console.error('‚ùå Failed to generate stats:', error.message);
            }
          "

      - name: Check documentation endpoints
        working-directory: server-v2
        run: |
          echo "üîç Checking documentation endpoints..."

          # Test if docs routes are properly configured
          node -e "
            const http = require('http');
            
            const endpoints = [
              { path: '/api/v1/docs', name: 'Documentation Home' },
              { path: '/api/v1/docs/redoc', name: 'ReDoc' },
              { path: '/api/v1/docs/swagger', name: 'Swagger UI' },
              { path: '/api/v1/docs/json', name: 'OpenAPI JSON' },
              { path: '/api/v1/docs/yaml', name: 'OpenAPI YAML' },
              { path: '/api/v1/docs/postman', name: 'Postman Collection' }
            ];
            
            console.log('üìã Documentation Endpoints:');
            endpoints.forEach(endpoint => {
              console.log(\`  ‚úÖ \${endpoint.name}: \${endpoint.path}\`);
            });
            
            console.log('\\nüéâ All documentation endpoints configured successfully!');
          "

      - name: Check for common issues
        working-directory: server-v2
        run: |
          echo "üîç Checking for common OpenAPI issues..."

          node -e "
            const fs = require('fs');
            const yaml = require('js-yaml');
            
            try {
              const apiSpec = yaml.load(fs.readFileSync('src/docs/openapi.yaml', 'utf8'));
              let issues = [];
              
              // Check for required fields
              if (!apiSpec.openapi) {
                issues.push('Missing openapi version');
              }
              
              if (!apiSpec.info) {
                issues.push('Missing info object');
              } else {
                if (!apiSpec.info.title) issues.push('Missing API title');
                if (!apiSpec.info.version) issues.push('Missing API version');
              }
              
              // Check for empty paths
              if (!apiSpec.paths || Object.keys(apiSpec.paths).length === 0) {
                issues.push('No paths defined');
              }
              
              // Check for security
              if (!apiSpec.security && !apiSpec.components?.securitySchemes) {
                issues.push('No security schemes defined');
              }
              
              if (issues.length > 0) {
                console.log('‚ö†Ô∏è Found potential issues:');
                issues.forEach(issue => console.log(\`  - \${issue}\`));
                process.exit(1);
              } else {
                console.log('‚úÖ No common issues found');
              }
              
            } catch (error) {
              console.error('‚ùå Error checking issues:', error.message);
              process.exit(1);
            }
          "

      - name: Success notification
        if: success()
        run: |
          echo "üéâ OpenAPI validation completed successfully!"
          echo "üìö Documentation is ready for deployment"

  security-check:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint-openapi

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security scan
        working-directory: server-v2
        run: |
          echo "üîí Running security scan on OpenAPI specification..."

          # Check for sensitive information
          node -e "
            const fs = require('fs');
            const yaml = require('js-yaml');
            
            try {
              const content = fs.readFileSync('src/docs/openapi.yaml', 'utf8');
              const apiSpec = yaml.load(content);
              
              // Check for potential secrets
              const sensitivePatterns = [
                /password\s*[:=]\s*['\"].+['\"]/gi,
                /secret\s*[:=]\s*['\"].+['\"]/gi,
                /token\s*[:=]\s*['\"].+['\"]/gi,
                /key\s*[:=]\s*['\"].+['\"]/gi,
                /api[_-]?key\s*[:=]\s*['\"].+['\"]/gi
              ];
              
              let foundIssues = [];
              sensitivePatterns.forEach((pattern, index) => {
                if (pattern.test(content)) {
                  foundIssues.push(\`Potential sensitive information pattern \${index + 1}\`);
                }
              });
              
              if (foundIssues.length > 0) {
                console.log('‚ö†Ô∏è Security warnings:');
                foundIssues.forEach(issue => console.log(\`  - \${issue}\`));
                console.log('‚ùå Please review and remove any sensitive information');
                process.exit(1);
              } else {
                console.log('‚úÖ No sensitive information found');
              }
              
            } catch (error) {
              console.error('‚ùå Error during security scan:', error.message);
              process.exit(1);
            }
          "

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [lint-openapi, security-check]
    if: github.ref == 'refs/heads/main' && success()

    steps:
      - name: Deploy to staging
        run: |
          echo "üöÄ Deploying documentation to staging..."
          echo "Documentation available at: https://api.vauntico.com/v1/docs"

      - name: Notify deployment
        run: |
          echo "üì¢ Documentation deployment completed successfully!"
