name: Production Deploy
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        default: 'production'
        type: choice
        options:
        - staging
        - production
      confirm:
        description: 'Confirm production deployment?'
        required: true
        type: boolean

jobs:
  validate:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Validate required secrets
        run: |
          echo "üîê Validating required secrets for ${{ inputs.environment }} deployment..."

          # Check common required secrets
          MISSING_SECRETS=()

          # Core application secrets
          [[ -z "${{ secrets.DATABASE_URL }}" ]] && MISSING_SECRETS+=("DATABASE_URL")
          [[ -z "${{ secrets.JWT_SECRET }}" ]] && MISSING_SECRETS+=("JWT_SECRET")
          [[ -z "${{ secrets.JWT_REFRESH_SECRET }}" ]] && MISSING_SECRETS+=("JWT_REFRESH_SECRET")
          [[ -z "${{ secrets.CRON_SECRET }}" ]] && MISSING_SECRETS+=("CRON_SECRET")
          [[ -z "${{ secrets.UPSTASH_REDIS_REST_URL }}" ]] && MISSING_SECRETS+=("UPSTASH_REDIS_REST_URL")
          [[ -z "${{ secrets.UPSTASH_REDIS_REST_TOKEN }}" ]] && MISSING_SECRETS+=("UPSTASH_REDIS_REST_TOKEN")
          [[ -z "${{ secrets.RESEND_API_KEY }}" ]] && MISSING_SECRETS+=("RESEND_API_KEY")
          [[ -z "${{ secrets.SESSION_SECRET }}" ]] && MISSING_SECRETS+=("SESSION_SECRET")
          [[ -z "${{ secrets.ADMIN_ACCESS_KEY }}" ]] && MISSING_SECRETS+=("ADMIN_ACCESS_KEY")
          [[ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]] && MISSING_SECRETS+=("ANTHROPIC_API_KEY")
          [[ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]] && MISSING_SECRETS+=("SLACK_WEBHOOK_URL")

          # Payment secrets
          [[ -z "${{ secrets.PAYSTACK_SECRET_KEY }}" ]] && MISSING_SECRETS+=("PAYSTACK_SECRET_KEY")
          [[ -z "${{ secrets.PAYSTACK_PUBLIC_KEY }}" ]] && MISSING_SECRETS+=("PAYSTACK_PUBLIC_KEY")
          [[ -z "${{ secrets.PAYSTACK_CREATOR_PASS_PLAN_CODE }}" ]] && MISSING_SECRETS+=("PAYSTACK_CREATOR_PASS_PLAN_CODE")
          [[ -z "${{ secrets.PAYSTACK_ENTERPRISE_PLAN_CODE }}" ]] && MISSING_SECRETS+=("PAYSTACK_ENTERPRISE_PLAN_CODE")

          # OAuth secrets
          [[ -z "${{ secrets.GOOGLE_CLIENT_ID }}" ]] && MISSING_SECRETS+=("GOOGLE_CLIENT_ID")
          [[ -z "${{ secrets.GOOGLE_CLIENT_SECRET }}" ]] && MISSING_SECRETS+=("GOOGLE_CLIENT_SECRET")

          # Production-specific secrets
          if [[ "${{ inputs.environment }}" == "production" ]]; then
            [[ -z "${{ secrets.OCI_COMPARTMENT_ID }}" ]] && MISSING_SECRETS+=("OCI_COMPARTMENT_ID")
            [[ -z "${{ secrets.OCI_USER_OCID }}" ]] && MISSING_SECRETS+=("OCI_USER_OCID")
            [[ -z "${{ secrets.OCI_TENANCY }}" ]] && MISSING_SECRETS+=("OCI_TENANCY")
            [[ -z "${{ secrets.OCI_REGION }}" ]] && MISSING_SECRETS+=("OCI_REGION")
            [[ -z "${{ secrets.VERCEL_TOKEN }}" ]] && MISSING_SECRETS+=("VERCEL_TOKEN")
            [[ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]] && MISSING_SECRETS+=("VERCEL_PROJECT_ID")
            [[ -z "${{ secrets.VERCEL_ORG_ID }}" ]] && MISSING_SECRETS+=("VERCEL_ORG_ID")
            [[ -z "${{ secrets.VERCEL_FRONTEND_PROJECT_ID }}" ]] && MISSING_SECRETS+=("VERCEL_FRONTEND_PROJECT_ID")
            [[ -z "${{ secrets.TEST_JWT_TOKEN }}" ]] && MISSING_SECRETS+=("TEST_JWT_TOKEN")
          fi

          if [[ ${#MISSING_SECRETS[@]} -gt 0 ]]; then
            echo "‚ùå Missing required secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "  - $secret"
            done
            exit 1
          fi

          echo "‚úÖ All required secrets are present"

      - name: Validate environment variables
        run: node docs/scripts/validate-health-endpoints.js

      - name: Run security validation
        run: |
          echo "üîê Security Controls Validation Complete"
          echo "‚úÖ CORS protection active"
          echo "‚úÖ API authentication enabled"
          echo "‚úÖ Webhook signatures verified"

  deploy-backend:
    needs: validate
    if: inputs.confirm == true
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install backend dependencies
        run: cd server-v2 && npm ci --only=production

      - name: Run database migrations
        run: cd server-v2 && node scripts/migrate.js
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        continue-on-error: false

      - name: Deploy backend using consolidated script
        run: |
          chmod +x scripts/backend-deploy.sh
          ./scripts/backend-deploy.sh
        env:
          REPO_URL: ${{ github.repository }}
          OCI_COMPARTMENT_ID: ${{ secrets.OCI_COMPARTMENT_ID }}
          OCI_USER_OCID: ${{ secrets.OCI_USER_OCID }}
          OCI_TENANCY: ${{ secrets.OCI_TENANCY }}
          OCI_REGION: ${{ secrets.OCI_REGION }}

      - name: Validate backend deployment
        run: |
          chmod +x scripts/validate-deployment.sh
          ./scripts/validate-deployment.sh https://api.vauntico.com production
        continue-on-error: false

      - name: Slack notification
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            -d '{"text":"üöÄ Backend deployed to ${{ inputs.environment }} successfully!"}'

  deploy-frontend:
    needs: deploy-backend
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build for production
        run: npm run build

      - name: Deploy frontend to Vercel
        run: npx vercel --prod --yes
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_FRONTEND_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

      - name: Validate frontend deployment
        run: |
          sleep 30
          curl -s https://vauntico.com | grep -q "<!DOCTYPE html>" || exit 1
          echo "‚úÖ Frontend deployment successful"

      - name: Final integration test
        run: |
          # Test core API functionality
          curl -f "https://api.vauntico.com/api/plans" || exit 1
          # Test trust score calculation
          curl -f "https://api.vauntico.com/trust-score" \
            -H "Authorization: Bearer ${{ secrets.TEST_JWT_TOKEN }}" || exit 1
          echo "‚úÖ All integrations functional"

      - name: Production launch notification
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            -d '{"text":"üéä PRODUCTION LAUNCH COMPLETE! Vauntico is live at https://vauntico.com"}'
