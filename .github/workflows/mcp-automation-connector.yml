name: MCP Automation Connector

on:
  workflow_dispatch:
    inputs:
      automation_action:
        description: "Automation Action"
        required: true
        default: "validate"
        type: choice
        options:
          - validate
          - merge
          - golive
          - batch
          - incident
  push:
    branches: [main]
    paths:
      - "scripts/*.sh"
      - "INCIDENT_RESPONSE_PLAYBOOK.md"
      - ".github/workflows/automation*"

jobs:
  merge-strategy-validation:
    runs-on: ubuntu-latest
    outputs:
      merge-status: ${{ steps.validate.outputs.status }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate merge strategy
        id: validate
        run: |
          echo "üîÑ Validating merge strategy..."

          # Check for merge strategy scripts
          if [ -f "merge-strategy-workflow.sh" ]; then
            echo "‚úÖ Merge strategy script found"
            
            # Make script executable
            chmod +x merge-strategy-workflow.sh
            echo "‚úÖ Made merge strategy script executable"
            
            # Check script content
            if grep -q "squash" merge-strategy-workflow.sh; then
              echo "‚úÖ Squash merge strategy supported"
            fi
            
            if grep -q "merge" merge-strategy-workflow.sh; then
              echo "‚úÖ Standard merge strategy supported"
            fi
            
            if grep -q "rebase" merge-strategy-workflow.sh; then
              echo "‚úÖ Rebase merge strategy supported"
            fi
            
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Merge strategy script missing"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  go-live-validation:
    runs-on: ubuntu-latest
    needs: merge-strategy-validation
    if: needs.merge-strategy-validation.outputs.merge-status == 'success'
    outputs:
      golive-status: ${{ steps.validate.outputs.status }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate go-live process
        id: validate
        run: |
          echo "üöÄ Validating go-live process..."

          # Check for go-live validation script
          if [ -f "go-live-validation.sh" ]; then
            echo "‚úÖ Go-live validation script found"
            
            # Make script executable
            chmod +x go-live-validation.sh
            echo "‚úÖ Made go-live validation script executable"
            
            # Check script content
            GO_LIVE_CHECKS=(
              "health_endpoint"
              "database_connection"
              "api_functionality"
              "monitoring_setup"
            )
            
            MISSING_CHECKS=0
            for check in "${GO_LIVE_CHECKS[@]}"; do
              if ! grep -q "$check" go-live-validation.sh; then
                echo "‚ö†Ô∏è Missing go-live check: $check"
                MISSING_CHECKS=1
              fi
            done
            
            if [ $MISSING_CHECKS -eq 0 ]; then
              echo "‚úÖ All essential go-live checks present"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è Some essential go-live checks may be missing"
              echo "status=success" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Go-live validation script missing"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  batch-commit-validation:
    runs-on: ubuntu-latest
    needs: merge-strategy-validation
    if: needs.merge-strategy-validation.outputs.merge-status == 'success' && (github.event_name == 'workflow_dispatch' && github.event.inputs.automation_action == 'batch')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate batch commit process
        run: |
          echo "üì¶ Validating batch commit process..."

          # Check for batch commit configuration
          BATCH_CONFIG=(
            "enabled"
            "max_size"
            "frequency"
          )

          MISSING_CONFIG=0
          for config in "${BATCH_CONFIG[@]}"; do
            if ! grep -q "$config" kilo_mcp_config.json; then
              echo "‚ö†Ô∏è Missing batch config: $config"
              MISSING_CONFIG=1
            fi
          done

          if [ $MISSING_CONFIG -eq 0 ]; then
            echo "‚úÖ Batch commit configuration present"
            
            # Extract batch commit settings
            BATCH_ENABLED=$(jq -r '.mcp_connectors[] | select(.name == "automation") | .config.batch_commit.enabled' kilo_mcp_config.json)
            BATCH_MAX_SIZE=$(jq -r '.mcp_connectors[] | select(.name == "automation") | .config.batch_commit.max_size' kilo_mcp_config.json)
            BATCH_FREQUENCY=$(jq -r '.mcp_connectors[] | select(.name == "automation") | .config.batch_commit.frequency' kilo_mcp_config.json)
            
            echo "üìä Batch commit settings:"
            echo "- Enabled: $BATCH_ENABLED"
            echo "- Max size: $BATCH_MAX_SIZE"
            echo "- Frequency: $BATCH_FREQUENCY"
          else
            echo "‚ö†Ô∏è Batch commit configuration incomplete"
          fi

  incident-response-validation:
    runs-on: ubuntu-latest
    needs: merge-strategy-validation
    if: needs.merge-strategy-validation.outputs.merge-status == 'success' && (github.event_name == 'workflow_dispatch' && github.event.inputs.automation_action == 'incident')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate incident response
        run: |
          echo "üö® Validating incident response..."

          # Check for incident response playbook
          if [ -f "INCIDENT_RESPONSE_PLAYBOOK.md" ]; then
            echo "‚úÖ Incident response playbook found"
            
            # Check playbook content
            PLAYBOOK_SECTIONS=(
              "Severity Levels"
              "Response Team"
              "Communication"
              "Resolution"
              "Post-Mortem"
            )
            
            MISSING_SECTIONS=0
            for section in "${PLAYBOOK_SECTIONS[@]}"; do
              if ! grep -q "$section" INCIDENT_RESPONSE_PLAYBOOK.md; then
                echo "‚ö†Ô∏è Missing playbook section: $section"
                MISSING_SECTIONS=1
              fi
            done
            
            if [ $MISSING_SECTIONS -eq 0 ]; then
              echo "‚úÖ All essential playbook sections present"
            else
              echo "‚ö†Ô∏è Some essential playbook sections may be missing"
            fi
            
            # Check severity levels
            SEVERITY_LEVELS=$(grep -c "severity" INCIDENT_RESPONSE_PLAYBOOK.md)
            echo "üìä Found $SEVERITY_LEVELS severity levels"
          else
            echo "‚ùå Incident response playbook missing"
          fi

  automation-test:
    runs-on: ubuntu-latest
    needs: [merge-strategy-validation, go-live-validation]
    if: needs.merge-strategy-validation.outputs.merge-status == 'success' && needs.go-live-validation.outputs.golive-status == 'success' && (github.event_name == 'workflow_dispatch' && github.event.inputs.automation_action == 'test')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test automation workflows
        run: |
          echo "üß™ Testing automation workflows..."

          # Test merge strategy script
          if [ -f "merge-strategy-workflow.sh" ]; then
            echo "üìã Testing merge strategy script..."
            ./merge-strategy-workflow.sh --help || true
            echo "‚úÖ Merge strategy script testable"
          fi

          # Test go-live validation script
          if [ -f "go-live-validation.sh" ]; then
            echo "üìã Testing go-live validation script..."
            ./go-live-validation.sh --help || true
            echo "‚úÖ Go-live validation script testable"
          fi

          echo "‚úÖ Automation workflows test completed"

  automation-validation:
    runs-on: ubuntu-latest
    needs:
      [
        merge-strategy-validation,
        go-live-validation,
        batch-commit-validation,
        incident-response-validation,
        automation-test,
      ]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate automation setup
        run: |
          echo "üîê Validating automation configuration..."

          # Check if all automation components are present
          AUTOMATION_COMPONENTS=(
            "merge-strategy-workflow.sh"
            "go-live-validation.sh"
            "INCIDENT_RESPONSE_PLAYBOOK.md"
          )

          MISSING_COMPONENTS=0
          for component in "${AUTOMATION_COMPONENTS[@]}"; do
            if [ ! -f "$component" ]; then
              echo "‚ùå Missing component: $component"
              MISSING_COMPONENTS=1
            fi
          done

          if [ $MISSING_COMPONENTS -eq 0 ]; then
            echo "‚úÖ All automation components present"
          else
            echo "‚ùå Some automation components missing"
          fi

          # Check automation coverage
          MERGE_STRATEGIES=$(grep -c "strategy" merge-strategy-workflow.sh)
          GO_LIVE_CHECKS=$(grep -c "check" go-live-validation.sh)

          echo "üìä Automation coverage:"
          echo "- Merge strategies: $MERGE_STRATEGIES"
          echo "- Go-live checks: $GO_LIVE_CHECKS"

  notification:
    runs-on: ubuntu-latest
    needs:
      [
        merge-strategy-validation,
        go-live-validation,
        batch-commit-validation,
        incident-response-validation,
        automation-test,
        automation-validation,
      ]
    if: always()
    steps:
      - name: Send automation notification
        run: |
          echo "üì¢ Sending automation notification..."

          # Check if Slack webhook URL is available
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            ACTION="${{ github.event.inputs.automation_action || 'validate' }}"
            
            if [ "${{ needs.merge-strategy-validation.outputs.merge-status }}" = "success" ] &&
               [ "${{ needs.go-live-validation.outputs.golive-status }}" = "success" ] &&
               [ "${{ needs.automation-validation.result }}" = "success" ]; then
              if [ "$ACTION" = "validate" ]; then
                MESSAGE="üîÑ Automation validation completed! ‚úÖ Merge strategy and go-live processes validated"
              elif [ "$ACTION" = "merge" ]; then
                MESSAGE="üîÑ Merge strategy validated! ‚úÖ Merge strategy workflow configured"
              elif [ "$ACTION" = "golive" ]; then
                MESSAGE="üöÄ Go-live validation completed! ‚úÖ Go-live process validated"
              elif [ "$ACTION" = "batch" ]; then
                MESSAGE="üì¶ Batch commit validated! ‚úÖ Batch commit process configured"
              elif [ "$ACTION" = "incident" ]; then
                MESSAGE="üö® Incident response validated! ‚úÖ Incident response playbook ready"
              fi
            else
              MESSAGE="‚ö†Ô∏è Automation operation completed with issues. Please review the logs for details."
            fi
            
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H 'Content-type: application/json' \
              -d "{\"text\":\"$MESSAGE\"}" \
              --max-time 30
          else
            echo "üì¢ Slack webhook URL not configured, skipping notification"
          fi
