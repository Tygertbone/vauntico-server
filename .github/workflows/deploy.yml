name: Deploy Vauntico Backend

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Job 1: Install & configure OCI CLI
  install-oci:
    runs-on: ubuntu-latest
    outputs:
      oci-configured: ${{ steps.configure.outputs.success }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip jq curl

      - name: Install OCI CLI
        run: |
          # Upgrade pip and install OCI CLI
          python3 -m pip install --upgrade pip
          pip install oci-cli
          
          # Verify installation
          oci --version
          
          # Add OCI CLI to PATH
          echo ~/.local/bin >> $GITHUB_PATH

      - name: Configure OCI CLI
        id: configure
        run: |
          # Check if required secrets are available
          if [ -z "${{ secrets.OCI_PRIVATE_KEY }}" ] || [ -z "${{ secrets.OCI_USER_OCID }}" ] || [ -z "${{ secrets.OCI_TENANCY_OCID }}" ] || [ -z "${{ secrets.OCI_FINGERPRINT }}" ] || [ -z "${{ secrets.OCI_REGION }}" ]; then
            echo "‚ùå Required OCI secrets are missing"
            echo "Missing secrets:"
            [ -z "${{ secrets.OCI_PRIVATE_KEY }}" ] && echo "- OCI_PRIVATE_KEY"
            [ -z "${{ secrets.OCI_USER_OCID }}" ] && echo "- OCI_USER_OCID"
            [ -z "${{ secrets.OCI_TENANCY_OCID }}" ] && echo "- OCI_TENANCY_OCID"
            [ -z "${{ secrets.OCI_FINGERPRINT }}" ] && echo "- OCI_FINGERPRINT"
            [ -z "${{ secrets.OCI_REGION }}" ] && echo "- OCI_REGION"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Create OCI directory
          mkdir -p ~/.oci
          
          # Write private key from secret
          echo "${{ secrets.OCI_PRIVATE_KEY }}" | base64 -d > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          
          # Create OCI config file
          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF
          
          chmod 600 ~/.oci/config
          
          # Force API key authentication
          export OCI_CLI_AUTH=api_key
          
          # Validate configuration with timeout
          echo "üîç Testing OCI authentication..."
          if timeout 30 oci iam compartment list --compartment-id ${{ secrets.OCI_TENANCY_OCID }} --limit 1 --auth api_key >/dev/null 2>&1; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ OCI CLI configured successfully"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "‚ùå OCI CLI configuration failed"
            exit 1
          fi

  # Job 2: Authenticate with OCI
  authenticate-oci:
    runs-on: ubuntu-latest
    needs: install-oci
    if: needs.install-oci.outputs.oci-configured == 'true'
    outputs:
      auth-success: ${{ steps.auth.outputs.success }}
      namespace: ${{ steps.auth.outputs.namespace }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OCI CLI
        run: |
          python3 -m pip install --upgrade pip
          pip install oci-cli
          echo ~/.local/bin >> $GITHUB_PATH

      - name: Authenticate and get namespace
        id: auth
        run: |
          # Configure OCI CLI
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" | base64 -d > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          
          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF
          
          chmod 600 ~/.oci/config
          
          # Force API key authentication
          export OCI_CLI_AUTH=api_key
          
          # Test authentication with timeout
          echo "üîê Testing OCI authentication..."
          if NAMESPACE=$(timeout 30 oci os ns get --query 'data' --raw-output --auth api_key 2>/dev/null); then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT
            echo "‚úÖ OCI authentication successful"
            echo "üì¶ Object Storage Namespace: $NAMESPACE"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "‚ùå OCI authentication failed"
            exit 1
          fi

  # Job 3: Deploy services
  deploy-services:
    runs-on: ubuntu-latest
    needs: authenticate-oci
    if: needs.authenticate-oci.outputs.auth-success == 'true'
    outputs:
      deployment-url: ${{ steps.deploy.outputs.url }}
      deployment-success: ${{ steps.deploy.outputs.success }}
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          # Install OCI CLI
          python3 -m pip install --upgrade pip
          pip install oci-cli
          echo ~/.local/bin >> $GITHUB_PATH
          
          # Install system deps
          sudo apt-get update
          sudo apt-get install -y jq openssh-client

      - name: Configure OCI for deployment
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" | base64 -d > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          
          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF
          
          chmod 600 ~/.oci/config
          
          # Force API key authentication
          export OCI_CLI_AUTH=api_key

      - name: Deploy to Railway (fallback)
        id: deploy
        run: |
          echo "üöÄ Starting deployment process..."
          
          # Check if Railway token is available
          if [ -n "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "üì° Deploying to Railway..."
            
            # Install Railway CLI
            npm install -g @railway/cli
            
            # Deploy to Railway with timeout
            if timeout 300 railway deploy --service=backend; then
              echo "success=true" >> $GITHUB_OUTPUT
              echo "url=https://api.vauntico.com" >> $GITHUB_OUTPUT
              echo "‚úÖ Railway deployment successful"
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "‚ùå Railway deployment failed or timed out"
              exit 1
            fi
          else
            echo "üèóÔ∏è Deploying to OCI (using bastion method)..."
            
            # Check if OCI bastion secrets are available
            if [ -n "${{ secrets.OCI_BASTION_CONFIG }}" ] && [ -n "${{ secrets.OCI_BASTION_CIDR }}" ]; then
              echo '${{ secrets.OCI_BASTION_CONFIG }}' > bastion-config.json
              echo '${{ secrets.OCI_BASTION_CIDR }}' > bastion-cidr.json
              
              # Make scripts executable
              chmod +x scripts/deploy-via-bastion.sh scripts/validate-deployment.sh
              
              # Deploy via bastion with timeout
              if timeout 300 ./scripts/deploy-via-bastion.sh deploy; then
                echo "success=true" >> $GITHUB_OUTPUT
                echo "url=https://api.vauntico.com" >> $GITHUB_OUTPUT
                echo "‚úÖ OCI deployment via bastion successful"
              else
                echo "success=false" >> $GITHUB_OUTPUT
                echo "‚ùå OCI deployment via bastion failed or timed out"
                exit 1
              fi
            else
              echo "‚ùå No deployment method available"
              echo "Missing secrets:"
              [ -z "${{ secrets.RAILWAY_TOKEN }}" ] && echo "- RAILWAY_TOKEN"
              [ -z "${{ secrets.OCI_BASTION_CONFIG }}" ] && echo "- OCI_BASTION_CONFIG"
              [ -z "${{ secrets.OCI_BASTION_CIDR }}" ] && echo "- OCI_BASTION_CIDR"
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
        env:
          OCI_CLI_AUTH: api_key
          OCI_TENANCY_OCID: ${{ secrets.OCI_TENANCY_OCID }}
          OCI_USER_OCID: ${{ secrets.OCI_USER_OCID }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_PRIVATE_KEY: ${{ secrets.OCI_PRIVATE_KEY }}
          OCI_BASTION_CONFIG: ${{ secrets.OCI_BASTION_CONFIG }}
          OCI_BASTION_CIDR: ${{ secrets.OCI_BASTION_CIDR }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # Job 4: Validate deployment
  validate-deployment:
    runs-on: ubuntu-latest
    needs: deploy-services
    if: needs.deploy-services.outputs.deployment-success == 'true'
    steps:
      - name: Wait for deployment to stabilize
        run: |
          echo "‚è≥ Waiting for services to fully start..."
          sleep 30

      - name: Health check against API endpoint
        run: |
          API_URL="${{ needs.deploy-services.outputs.deployment-url }}"
          echo "üîç Performing health check against: $API_URL/health"
          
          # Try health check with retries and timeouts
          for i in {1..5}; do
            echo "üì° Health check attempt $i/5..."
            
            if timeout 10 curl -f -s -o /dev/null -w "%{http_code}" "$API_URL/health" | grep -q "200\|302"; then
              echo "‚úÖ Health check passed - API is responding"
              
              # Additional detailed check
              RESPONSE=$(timeout 10 curl -s "$API_URL/health" || echo "{}")
              echo "üìä Health response: $RESPONSE"
              
              # Check if response contains expected fields
              if echo "$RESPONSE" | jq -e '.status' >/dev/null 2>&1; then
                echo "‚úÖ API health endpoint is properly configured"
                exit 0
              else
                echo "‚ö†Ô∏è API responded but health format unexpected"
              fi
            else
              echo "‚ö†Ô∏è Health check failed, retrying in 10 seconds..."
              sleep 10
            fi
          done
          
          echo "‚ùå Health check failed after 5 attempts"
          exit 1

      - name: Basic functionality test
        run: |
          API_URL="${{ needs.deploy-services.outputs.deployment-url }}"
          echo "üß™ Testing basic API functionality..."
          
          # Test a simple endpoint with timeout
          if timeout 10 curl -f -s "$API_URL/" >/dev/null; then
            echo "‚úÖ Basic API endpoint accessible"
          else
            echo "‚ö†Ô∏è Basic API endpoint not accessible, but deployment may still be valid"
          fi
          
          echo "üéâ Deployment validation completed"

  # Notification job (runs regardless of deployment outcome)
  notify:
    runs-on: ubuntu-latest
    needs: [deploy-services, validate-deployment]
    if: always()
    steps:
      - name: Send Slack notification
        run: |
          # Check if Slack webhook URL is available
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            if [ "${{ needs.deploy-services.outputs.deployment-success }}" = "true" ] && [ "${{ needs.validate-deployment.result }}" = "success" ]; then
              curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
                -H 'Content-type: application/json' \
                -d '{"text":"üöÄ Vauntico backend deployed and validated successfully! API: ${{ needs.deploy-services.outputs.deployment-url }}"}'
            elif [ "${{ needs.deploy-services.outputs.deployment-success }}" = "true" ]; then
              curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
                -H 'Content-type: application/json' \
                -d '{"text":"‚ö†Ô∏è Vauntico backend deployed but validation failed. Please check the API: ${{ needs.deploy-services.outputs.deployment-url }}"}'
            else
              curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
                -H 'Content-type: application/json' \
                -d '{"text":"‚ùå Vauntico backend deployment failed. Please check GitHub Actions logs."}'
            fi
          else
            echo "üì¢ Slack webhook URL not configured, skipping notification"
          fi

  # Cleanup job
  cleanup:
    runs-on: ubuntu-latest
    needs: [deploy-services, validate-deployment]
    if: always()
    steps:
      - name: Cleanup deployment artifacts
        run: |
          echo "üßπ Cleaning up deployment artifacts..."
          
          # Remove any temporary files
          rm -f bastion-config.json bastion-cidr.json
          rm -rf ~/.oci/oci_api_key.pem ~/.oci/config
          
          echo "‚úÖ Cleanup completed"
        continue-on-error: true