# =============================================================================
# VAUNTICO PROMETHEUS CONFIGURATION - ENVIRONMENT STANDARDIZED
# =============================================================================
# Phase 1: Foundation - KPI Monitoring and Alerting
# Updated: 2026-01-07 - Environment Standardization

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: "vauntico"
    environment: "${ENVIRONMENT:-development}"
    phase: "phase1-foundation"

rule_files:
  - "alert_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

scrape_configs:
  # =============================================================================
  # APPLICATION SERVICES
  # =============================================================================

  # Trust Score Backend (server-v2)
  - job_name: "trust-score-backend"
    static_configs:
      - targets: ["trust-score-backend:8080"]
    metrics_path: "/metrics"
    scrape_interval: 30s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "trust-score-backend"
      - source_labels: [__address__]
        target_label: service
        replacement: "trust-score-backend"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"
      - source_labels: [__address__]
        target_label: version
        replacement: "${VERSION:-latest}"

  # Vauntico Server
  - job_name: "vauntico-server"
    static_configs:
      - targets: ["vauntico-server:8080"]
    metrics_path: "/metrics"
    scrape_interval: 30s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "vauntico-server"
      - source_labels: [__address__]
        target_label: service
        replacement: "vauntico-server"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"
      - source_labels: [__address__]
        target_label: version
        replacement: "${VERSION:-latest}"

  # Fulfillment Engine
  - job_name: "fulfillment-engine"
    static_configs:
      - targets: ["fulfillment-engine:8080"]
    metrics_path: "/metrics"
    scrape_interval: 30s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "fulfillment-engine"
      - source_labels: [__address__]
        target_label: service
        replacement: "fulfillment-engine"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"
      - source_labels: [__address__]
        target_label: version
        replacement: "${VERSION:-latest}"

  # Legacy Server
  - job_name: "legacy-server"
    static_configs:
      - targets: ["legacy-server:8080"]
    metrics_path: "/metrics"
    scrape_interval: 30s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "legacy-server"
      - source_labels: [__address__]
        target_label: service
        replacement: "legacy-server"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"
      - source_labels: [__address__]
        target_label: version
        replacement: "${VERSION:-latest}"

  # =============================================================================
  # INFRASTRUCTURE SERVICES
  # =============================================================================

  # PostgreSQL Database
  - job_name: "postgres"
    static_configs:
      - targets: ["postgres:5432"]
    metrics_path: "/metrics"
    scrape_interval: 30s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "postgres"
      - source_labels: [__address__]
        target_label: service
        replacement: "database"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"

  # Redis Cache
  - job_name: "redis"
    static_configs:
      - targets: ["redis:6379"]
    metrics_path: "/metrics"
    scrape_interval: 30s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "redis"
      - source_labels: [__address__]
        target_label: service
        replacement: "cache"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"

  # =============================================================================
  # KPI SPECIFIC METRICS
  # =============================================================================

  # KPI Tracking Endpoints
  - job_name: "vauntico-kpi"
    static_configs:
      - targets: ["trust-score-backend:8080"]
    metrics_path: "/api/v1/metrics/kpi"
    scrape_interval: 60s
    scrape_timeout: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "trust-score-backend"
      - source_labels: [__address__]
        target_label: service
        replacement: "kpi-tracking"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"

  # Database Health Monitoring
  - job_name: "vauntico-db-health"
    static_configs:
      - targets: ["trust-score-backend:8080"]
    metrics_path: "/db-health"
    scrape_interval: 30s
    scrape_timeout: 5s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "trust-score-backend"
      - source_labels: [__address__]
        target_label: service
        replacement: "database-health"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"

  # Blind Spot Monitoring
  - job_name: "vauntico-blind-spots"
    static_configs:
      - targets: ["trust-score-backend:8080"]
    metrics_path: "/api/v1/metrics/blind-spots"
    scrape_interval: 300s # Every 5 minutes
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "trust-score-backend"
      - source_labels: [__address__]
        target_label: service
        replacement: "blind-spot-monitoring"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"

  # Deployment Tracking
  - job_name: "vauntico-deployment"
    static_configs:
      - targets: ["trust-score-backend:8080"]
    metrics_path: "/api/v1/metrics/deployment-tracking"
    scrape_interval: 600s # Every 10 minutes
    scrape_timeout: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "trust-score-backend"
      - source_labels: [__address__]
        target_label: service
        replacement: "deployment-tracking"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"

  # =============================================================================
  # PHASE 3 ENTERPRISE COMPLIANCE METRICS
  # =============================================================================

  # Enterprise Compliance Status
  - job_name: "vauntico-enterprise-compliance"
    static_configs:
      - targets: ["trust-score-backend:8080"]
    metrics_path: "/api/v1/enterprise/compliance/status"
    scrape_interval: 60s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "trust-score-backend"
      - source_labels: [__address__]
        target_label: service
        replacement: "enterprise-compliance"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"

  # Enterprise Integration Health
  - job_name: "vauntico-enterprise-integrations"
    static_configs:
      - targets: ["trust-score-backend:8080"]
    metrics_path: "/api/v1/enterprise/integrations/health"
    scrape_interval: 30s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "trust-score-backend"
      - source_labels: [__address__]
        target_label: service
        replacement: "enterprise-integrations"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"

  # Enterprise Dashboard Overview
  - job_name: "vauntico-enterprise-dashboard"
    static_configs:
      - targets: ["trust-score-backend:8080"]
    metrics_path: "/api/v1/enterprise/dashboard"
    scrape_interval: 120s
    scrape_timeout: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "trust-score-backend"
      - source_labels: [__address__]
        target_label: service
        replacement: "enterprise-dashboard"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"

  # =============================================================================
  # SYSTEM MONITORING
  # =============================================================================

  # Node Exporter - System Metrics
  - job_name: "node-exporter"
    static_configs:
      - targets: ["node-exporter:9100"]
    scrape_interval: 30s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "host-system"
      - source_labels: [__address__]
        target_label: service
        replacement: "system-metrics"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"

  # cAdvisor - Container Metrics
  - job_name: "cadvisor"
    static_configs:
      - targets: ["cadvisor:8080"]
    metrics_path: "/metrics"
    scrape_interval: 30s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "docker-host"
      - source_labels: [__address__]
        target_label: service
        replacement: "container-metrics"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"

  # Uptime Kuma - Service Monitoring
  - job_name: "uptime-kuma"
    static_configs:
      - targets: ["uptime-kuma:3001"]
    metrics_path: "/metrics"
    scrape_interval: 60s
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: "uptime-kuma"
      - source_labels: [__address__]
        target_label: service
        replacement: "uptime-monitoring"
      - source_labels: [__address__]
        target_label: environment
        replacement: "${ENVIRONMENT:-development}"

# Monetization Phase 1 KPIs
# Target: 100K MRR from creators
recording_rules:
  - name: vauntico_phase1_kpis
    interval: 60s
    rules:
      # Pro Subscriptions (Primary revenue driver)
      - record: vauntico:pro_subscriptions:current
        expr: increase(pro_subscriptions_total[5m])

      # Score Insurance Signups (Secondary revenue)
      - record: vauntico:score_insurance_signups:current
        expr: increase(score_insurance_signups_total[5m])

      # Trust Calculator Usage (Engagement metric)
      - record: vauntico:trust_calculator_usage:current
        expr: increase(trust_calculator_usage_total[5m])

      # MRR Calculation
      - record: vauntico:mrr:current
        expr: (vauntico:pro_subscriptions:current * 99) + (vauntico:score_insurance_signups:current * 29)

      # MRR Progress towards Phase 1 Target
      - record: vauntico:mrr:progress_percentage
        expr: (vauntico:mrr:current / 100000) * 100

# Alert Rules for Critical KPIs
alert_rules.yml: |
  groups:
    - name: vauntico_critical_alerts
      rules:
        # Application Health Alerts
        - alert: ApplicationDown
          expr: up{job="vauntico-backend"} == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Vauntico backend is down"
            description: "Vauntico backend has been down for more than 1 minute"

        - alert: DatabaseDown
          expr: up{job="vauntico-db-health"} == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "Database connectivity lost"
            description: "Database has been unreachable for more than 2 minutes"

        # KPI Performance Alerts
        - alert: LowSubscriptionRate
          expr: increase(pro_subscriptions_total[1h]) < 5
          for: 30m
          labels:
            severity: warning
          annotations:
            summary: "Low subscription rate detected"
            description: "Less than 5 pro subscriptions in the last hour"

        - alert: MRRBehindTarget
          expr: vauntico:mrr:progress_percentage < 10
          for: 1h
          labels:
            severity: warning
          annotations:
            summary: "MRR significantly behind target"
            description: "Current MRR progress is less than 10% of Phase 1 target"

        # Blind Spot Monitoring Alerts
        - alert: BlindSpotCheckFailed
          expr: blind_spot_check_success == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Blind spot mitigation check failed"
            description: "One or more blind spot mitigations are not functioning properly"

        # =======================================================================
        # PHASE 3 ENTERPRISE COMPLIANCE ALERTS
        # =======================================================================
        
        # Enterprise Compliance Alerts
        - alert: EnterpriseComplianceScoreLow
          expr: vauntico_compliance_score < 90
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Enterprise compliance score below threshold"
            description: "Enterprise compliance score is {{ $value }}%, below the 90% threshold"

        - alert: POPIAComplianceViolation
          expr: rate(vauntico_compliance_events_total{framework="popia"}[5m]) > 10
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "POPIA compliance violation detected"
            description: "High rate of POPIA compliance events detected"

        - alert: GDPRComplianceViolation
          expr: rate(vauntico_compliance_events_total{framework="gdpr"}[5m]) > 5
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "GDPR compliance violation detected"
            description: "High rate of GDPR compliance events detected"

        # Integration Health Alerts
        - alert: SlackIntegrationDown
          expr: vauntico_integration_health{integration="slack"} == 0
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "Slack integration is down"
            description: "Slack integration has been down for more than 2 minutes"

        - alert: NotionIntegrationDown
          expr: vauntico_integration_health{integration="notion"} == 0
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "Notion integration is down"
            description: "Notion integration has been down for more than 2 minutes"

        - alert: WebhookDeliveryFailure
          expr: rate(vauntico_webhook_deliveries_failed_total[5m]) / rate(vauntico_webhook_deliveries_total[5m]) > 0.1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High webhook failure rate"
            description: "Webhook failure rate is above 10%"

        # Enterprise SLA Alerts
        - alert: EnterpriseSLAViolation
          expr: vauntico_sla_uptime_percentage < 99.9
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Enterprise SLA violation"
            description: "Uptime is {{ $value }}%, below the 99.9% SLA requirement"

        # Data Privacy Alerts
        - alert: DataRetentionViolation
          expr: vauntico_data_retention_compliance < 1
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Data retention compliance violation"
            description: "Data retention policy violation detected for {{ $labels.data_category }}"

        - alert: CrossBorderTransferAnomaly
          expr: rate(vauntico_cross_border_transfers_total[5m]) > 50
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Anomalous cross-border data transfers"
            description: "Unusually high rate of cross-border data transfers detected"

        # Enterprise KPI Alerts
        - alert: EnterpriseMRRGrowthStagnant
          expr: increase(vauntico_enterprise_mrr[1h]) < 1000
          for: 30m
          labels:
            severity: warning
          annotations:
            summary: "Enterprise MRR growth stagnant"
            description: "Enterprise MRR growth is less than $1000 in the last hour"

        - alert: EnterpriseUserChurnHigh
          expr: rate(vauntico_enterprise_users_lost_total[5m]) > 0.01
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High enterprise user churn"
            description: "Enterprise user churn rate is above 1%"

        # Audit and Security Alerts
        - alert: ComplianceAuditEventSpike
          expr: rate(vauntico_audit_events_total{type="compliance"}[5m]) > 100
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Compliance audit event spike"
            description: "Unusual spike in compliance audit events detected"

        - alert: EnterpriseSecurityEvent
          expr: rate(vauntico_audit_events_total{type="enterprise"}[5m]) > 50
          for: 3m
          labels:
            severity: critical
          annotations:
            summary: "Enterprise security event detected"
            description: "High rate of enterprise security events detected"
