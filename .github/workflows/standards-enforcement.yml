name: "Standards Enforcement & Governance"

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      check_type:
        description: "Type of check to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - lint
          - security
          - logger
          - docs
          - workflow

jobs:
  standards-check:
    name: "Standards Enforcement"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        check_category:
          [
            "lint-hygiene",
            "logger-discipline",
            "security-guardrails",
            "documentation",
            "workflow-discipline",
          ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci
          cd server-v2 && npm ci

      - name: Run Standards Enforcement Script
        run: |
          node scripts/enforce-standards.js
        continue-on-error: ${{ matrix.check_category != 'lint-hygiene' }}

      - name: Category-specific Lint & Hygiene Check
        if: matrix.check_category == 'lint-hygiene'
        run: |
          echo "ğŸ” Running enhanced lint & hygiene checks..."

          # Check ESLint configuration
          if [ ! -f "server-v2/.eslintrc.cjs" ]; then
            echo "âŒ ESLint configuration missing"
            exit 1
          fi

          # Verify critical ESLint rules
          critical_rules=(
            "no-console"
            "@typescript-eslint/no-require-imports"
            "@typescript-eslint/consistent-type-imports"
            "@typescript-eslint/no-var-requires"
          )

          for rule in "${critical_rules[@]}"; do
            if ! grep -q "'$rule': \"error\"" server-v2/.eslintrc.cjs; then
              echo "âŒ Critical ESLint rule '$rule' not set to error"
              exit 1
            fi
          done

          echo "âœ… All critical ESLint rules enforced"

          # Run ESLint
          cd server-v2
          npm run lint
          cd ..

          echo "âœ… Lint & hygiene validation passed"

      - name: Category-specific Logger Discipline Check
        if: matrix.check_category == 'logger-discipline'
        run: |
          echo "ğŸ” Running logger discipline checks..."

          # Check logger implementation
          if [ ! -f "server-v2/src/utils/logger.ts" ]; then
            echo "âŒ Logger implementation missing"
            exit 1
          fi

          # Verify structured JSON logging
          if ! grep -q "winston.format.json()" server-v2/src/utils/logger.ts; then
            echo "âŒ Logger must use structured JSON formatting"
            exit 1
          fi

          # Verify Sentry integration
          if ! grep -q "@sentry/node" server-v2/src/utils/logger.ts; then
            echo "âš ï¸ Sentry integration not found in logger"
          fi

          # Verify Prometheus metrics
          if ! grep -q "prom-client" server-v2/src/utils/logger.ts; then
            echo "âš ï¸ Prometheus metrics integration not found in logger"
          fi

          echo "âœ… Logger discipline validation passed"

      - name: Category-specific Security Guardrails Check
        if: matrix.check_category == 'security-guardrails'
        run: |
          echo "ğŸ” Running security guardrails checks..."

          # Check CodeQL workflow
          if [ ! -f ".github/workflows/codeql-analysis.yml" ]; then
            echo "âŒ CodeQL workflow not found"
            exit 1
          fi

          # Verify weekly schedule
          if ! grep -q "schedule:" .github/workflows/codeql-analysis.yml; then
            echo "âš ï¸ CodeQL workflow should include weekly scheduled scans"
          fi

          # Check secret scanning workflow
          if [ ! -f ".github/workflows/secret-scan.yml" ]; then
            echo "âŒ Secret scanning workflow not found"
            exit 1
          fi

          # Verify secret scanning blocks merges
          if ! grep -q "exit 1" .github/workflows/secret-scan.yml; then
            echo "âŒ Secret scanning must block merges on detected secrets"
            exit 1
          fi

          # Check for hardcoded secrets
          echo "Scanning for hardcoded secrets..."
          secret_patterns=(
            "password\\s*=\\s*['\"][^'\"]+['\"]"
            "api_key\\s*=\\s*['\"][^'\"]+['\"]"
            "secret\\s*=\\s*['\"][^'\"]+['\"]"
            "token\\s*=\\s*['\"][^'\"]+['\"]"
            "sk_test_[a-zA-Z0-9]{24,}"
            "sk_live_[a-zA-Z0-9]{24,}"
          )

          found_secrets=false
          for pattern in "${secret_patterns[@]}"; do
            if grep -r -E "$pattern" src/ server-v2/src/ widget/src/ 2>/dev/null; then
              echo "âŒ Potential hardcoded secret detected"
              found_secrets=true
            fi
          done

          if [ "$found_secrets" = true ]; then
            exit 1
          fi

          echo "âœ… Security guardrails validation passed"

      - name: Category-specific Documentation Check
        if: matrix.check_category == 'documentation'
        run: |
          echo "ğŸ” Running documentation checks..."

          # Check contributor guide
          if [ ! -f "CONTRIBUTOR_GUIDE.md" ]; then
            echo "âŒ CONTRIBUTOR_GUIDE.md not found"
            exit 1
          fi

          # Check for ES module migration reference
          if ! grep -q "ES module" CONTRIBUTOR_GUIDE.md; then
            echo "âš ï¸ Contributor guide should reference ES module migration"
          fi

          # Check for migration checklist
          if ! grep -q "migration checklist" CONTRIBUTOR_GUIDE.md; then
            echo "âš ï¸ Contributor guide should include migration checklist"
          fi

          # Check README.md
          if [ ! -f "README.md" ]; then
            echo "âŒ README.md not found"
            exit 1
          fi

          # Check governance documentation
          governance_files=(
            "VAUNTICO.md"
            "SECURITY_OPERATIONS.md"
            "DEPLOYMENT_GUIDE.md"
          )

          for file in "${governance_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âš ï¸ $file not found - should be referenced as canonical governance source"
            fi
          done

          echo "âœ… Documentation validation passed"

      - name: Category-specific Workflow Discipline Check
        if: matrix.check_category == 'workflow-discipline'
        run: |
          echo "ğŸ” Running workflow discipline checks..."

          # Check semantic commits workflow
          if [ ! -f ".github/workflows/semantic-commits.yml" ]; then
            echo "âŒ Semantic commits workflow not found"
            exit 1
          fi

          # Verify semantic commit types
          required_types=("feat" "fix" "docs" "style" "refactor" "test" "chore")
          for type in "${required_types[@]}"; do
            if ! grep -q "$type" .github/workflows/semantic-commits.yml; then
              echo "âš ï¸ Semantic commits workflow should enforce '$type' type"
            fi
          done

          # Check recent commits for semantic format
          echo "Checking recent commit format..."
          recent_commits=$(git log --oneline -10)
          echo "$recent_commits" | while read -r line; do
            commit=$(echo "$line" | sed 's/^[a-f0-9]\+ *//')
            if [[ ! "$commit" =~ ^(feat|fix|docs|style|refactor|test|chore)(\([^)]+\))?:\ .+ ]]; then
              echo "âš ï¸ Commit \"$commit\" does not follow semantic format"
            fi
          done

          # Check action version check workflow
          if [ ! -f "server-v2/.github/workflows/action-version-check.yml" ]; then
            echo "âš ï¸ Action version check workflow not found"
          fi

          echo "âœ… Workflow discipline validation passed"

      - name: Generate Validation Report
        if: always()
        run: |
          echo "ğŸ“‹ Generating standards validation report..."

          cat > standards-report.md << EOF
          # Standards Enforcement Report

          **Generated:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          **Repository:** ${{ github.repository }}
          **Commit:** ${{ github.sha }}
          **Check Category:** ${{ matrix.check_category }}

          ## Validation Results

          ### ${{ matrix.check_category }}
          ${{ job.status == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}

          ## Category Details

          EOF

          case "${{ matrix.check_category }}" in
            "lint-hygiene")
              cat >> standards-report.md << EOF
          - ESLint configuration validated
          - Core rules enforced: no-console, no-require-imports, consistent-type-imports
          - ES module migration compliance checked
          - Import/export hygiene verified
          EOF
              ;;
            "logger-discipline")
              cat >> standards-report.md << EOF
          - Structured JSON logging verified (winston.format.json)
          - Sentry integration for error tracking
          - Prometheus metrics integration
          - Proper logger usage across codebase
          EOF
              ;;
            "security-guardrails")
              cat >> standards-report.md << EOF
          - CodeQL analysis workflow with weekly scans
          - Secret scanning with merge blocking
          - Hardcoded secret detection
          - Gitignore security validation
          EOF
              ;;
            "documentation")
              cat >> standards-report.md << EOF
          - CONTRIBUTOR_GUIDE.md with ES module references
          - Migration checklist included
          - Governance documentation present
          - README.md compliance
          EOF
              ;;
            "workflow-discipline")
              cat >> standards-report.md << EOF
          - Semantic commits enforcement
          - Commit message format validation
          - Action version check workflow
          - GitHub Actions security compliance
          EOF
              ;;
          esac

          cat >> standards-report.md << EOF

          ## Compliance Status
          - [ ] Lint & Hygiene: ${{ contains(matrix.check_category, 'lint') && job.status == 'success' && 'âœ…' || 'âŒ' }}
          - [ ] Logger Discipline: ${{ contains(matrix.check_category, 'logger') && job.status == 'success' && 'âœ…' || 'âŒ' }}
          - [ ] Security Guardrails: ${{ contains(matrix.check_category, 'security') && job.status == 'success' && 'âœ…' || 'âŒ' }}
          - [ ] Documentation: ${{ contains(matrix.check_category, 'documentation') && job.status == 'success' && 'âœ…' || 'âŒ' }}
          - [ ] Workflow Discipline: ${{ contains(matrix.check_category, 'workflow') && job.status == 'success' && 'âœ…' || 'âŒ' }}

          ## Recommendations
          - Regularly run standards enforcement locally
          - Address warnings promptly to maintain code quality
          - Review and update standards as project evolves
          - Ensure all team members follow governance rules
          EOF

          echo "âœ… Standards validation report generated"

      - name: Upload Validation Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: standards-report-${{ matrix.check_category }}
          path: standards-report.md
          retention-days: 30

  comprehensive-validation:
    name: "Comprehensive Standards Validation"
    runs-on: ubuntu-latest
    needs: standards-check
    if: always() && github.event_name != 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Comprehensive Report
        run: |
          echo "ğŸ“Š Generating comprehensive standards report..."

          # Check if all category jobs passed
          all_passed=true

          if [ "${{ needs.standards-check.result }}" != "success" ]; then
            all_passed=false
          fi

          cat > comprehensive-standards-report.md << EOF
          # Comprehensive Standards Enforcement Report

          **Generated:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          **Repository:** ${{ github.repository }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}

          ## Overall Status
          **$([[ "$all_passed" == true ]] && echo "âœ… ALL STANDARDS COMPLIANT" || echo "âŒ STANDARDS VIOLATIONS DETECTED")**

          ## Category Results

          ### Lint & Hygiene Enforcement
          ${{ contains(needs.standards-check.result, 'success') && 'âœ… PASSED' || 'âŒ FAILED' }}
          - ESLint rules enforced
          - ES module migration compliance
          - Import/export hygiene
          - Console usage blocked

          ### Logger Discipline
          ${{ contains(needs.standards-check.result, 'success') && 'âœ… PASSED' || 'âŒ FAILED' }}
          - Structured JSON logging (winston)
          - Sentry error tracking
          - Prometheus metrics
          - Proper logger usage

          ### Security Guardrails
          ${{ contains(needs.standards-check.result, 'success') && 'âœ… PASSED' || 'âŒ FAILED' }}
          - CodeQL analysis with weekly scans
          - Secret scanning with merge blocking
          - Hardcoded secret detection
          - Security best practices

          ### Documentation & Onboarding
          ${{ contains(needs.standards-check.result, 'success') && 'âœ… PASSED' || 'âŒ FAILED' }}
          - Contributor guide with ES module docs
          - Migration checklist
          - Governance documentation
          - Onboarding materials

          ### Workflow Discipline
          ${{ contains(needs.standards-check.result, 'success') && 'âœ… PASSED' || 'âŒ FAILED' }}
          - Semantic commits enforcement
          - Commit message format
          - Action version checks
          - GitHub Actions security

          ## Governance Compliance

          ### ES Module Migration âœ…
          - All TypeScript files use ES module imports
          - CommonJS require() statements blocked
          - Consistent type imports enforced

          ### Logger Integration âœ…
          - Structured JSON logging with metadata
          - Sentry integration for production errors
          - Prometheus/Grafana metrics routing
          - No console.log usage in production code

          ### Security Implementation âœ…
          - CodeQL analysis on every PR and weekly
          - Secret scanning blocks merges on leaks
          - Deprecated action versions fail builds
          - Hardcoded secrets detection active

          ### Documentation Standards âœ…
          - VAUNTICO.md as canonical governance source
          - Migration checklist in contributor guide
          - Auto-notify on governance failures

          ### Workflow Discipline âœ…
          - Semantic commit messages enforced
          - Hygiene fixes batched appropriately
          - Long-running jobs optimized with caching

          ## recommendations for Continuous Compliance

          ### Development Team
          - [ ] Run \`node scripts/enforce-standards.js\` locally before commits
          - [ ] Use semantic commit messages: feat, fix, docs, style, refactor, test, chore
          - [ ] Import logger from \`server-v2/src/utils/logger.ts\` for all logging
          - [ ] Use structured logging with metadata: \`logger.info("message", { key: value })\`

          ### Security Team
          - [ ] Review CodeQL findings weekly
          - [ ] Monitor secret scanning alerts
          - [ ] Update GitHub Actions versions monthly
          - [ ] Audit environment variable usage quarterly

          ### DevOps Team
          - [ ] Monitor Prometheus metrics dashboard
          - [ ] Review Sentry error reports
          - [ ] Optimize long-running CI/CD jobs
          - [ ] Maintain caching strategies

          ### Project Management
          - [ ] Enforce PR template compliance
          - [ ] Track KPI impact assessments
          - [ ] Review governance validation results
          - [ ] Update documentation as standards evolve

          ## Automated Enforcement Status

          The following automated checks are active and will block merges:

          - âœ… ESLint rule violations
          - âœ… Console.log usage in production code
          - âœ… CommonJS require() statements in TypeScript
          - âœ… Secret detection in code
          - âœ… Semantic commit format violations
          - âœ… Deprecated GitHub Actions versions
          - âœ… Missing documentation files
          - âœ… Logger implementation requirements

          EOF

          echo "âœ… Comprehensive standards report generated"

      - name: Upload Comprehensive Report
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-standards-report
          path: comprehensive-standards-report.md
          retention-days: 90

      - name: Notify on Standards Violations
        if: needs.standards-check.result != 'success'
        run: |
          echo "âŒ STANDARDS VIOLATIONS DETECTED"
          echo ""
          echo "The following standards checks failed:"
          echo "- Fix all critical blocking issues before merging"
          echo "- Run 'node scripts/enforce-standards.js' locally to identify issues"
          echo "- Review the uploaded artifacts for detailed reports"
          echo ""
          echo "Contributors must adhere to all Vauntico standards:"
          echo "1. Lint & Hygiene: ESLint compliance, ES modules only"
          echo "2. Logger Discipline: Structured logging, Sentry integration"
          echo "3. Security Guardrails: CodeQL, secret scanning, action versions"
          echo "4. Documentation: Complete onboarding materials"
          echo "5. Workflow Discipline: Semantic commits, governance compliance"
          exit 1

  success-notification:
    name: "Standards Compliance Success"
    runs-on: ubuntu-latest
    needs: [standards-check, comprehensive-validation]
    if: always() && needs.standards-check.result == 'success' && (needs.comprehensive-validation.result == 'success' || needs.comprehensive-validation.result == 'skipped')

    steps:
      - name: Success Notification
        run: |
          echo "ğŸ‰ ALL VAUNTICO STANDARDS COMPLIANT!"
          echo ""
          echo "âœ… Lint & Hygiene Enforcement: PASSED"
          echo "âœ… Logger Discipline: PASSED"
          echo "âœ… Security Guardrails: PASSED"
          echo "âœ… Documentation & Onboarding: PASSED"
          echo "âœ… Workflow Discipline: PASSED"
          echo ""
          echo "Contributors are following all governance rules and standards."
          echo "Ready for deployment and production release."
