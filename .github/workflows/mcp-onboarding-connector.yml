name: MCP Onboarding Connector

on:
  workflow_dispatch:
    inputs:
      onboarding_action:
        description: "Onboarding Action"
        required: true
        default: "validate"
        type: choice
        options:
          - validate
          - templates
          - hygiene
          - flow
          - test
  push:
    branches: [main]
    paths:
      - "CONTRIBUTOR_*.md"
      - "SYSTEMATIC_*.md"
      - ".github/ISSUE_TEMPLATE*"
      - ".github/PULL_REQUEST_TEMPLATE*"
  schedule:
    - cron: "0 0 * * 1" # Weekly onboarding check

jobs:
  contributor-guide-validation:
    runs-on: ubuntu-latest
    outputs:
      guide-status: ${{ steps.validate.outputs.status }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate contributor guides
        id: validate
        run: |
          echo "üìö Validating contributor guides..."

          # Check for essential contributor guides
          ESSENTIAL_GUIDES=(
            "CONTRIBUTOR_GUIDE.md"
            "CONTRIBUTOR_ONBOARDING.md"
            "SYSTEMATIC_PUSH_PULL_MERGE_PR_FLOW.md"
          )

          MISSING_GUIDES=0
          for guide in "${ESSENTIAL_GUIDES[@]}"; do
            if [ ! -f "$guide" ]; then
              echo "‚ùå Missing guide: $guide"
              MISSING_GUIDES=1
            fi
          done

          if [ $MISSING_GUIDES -eq 0 ]; then
            echo "‚úÖ All essential contributor guides present"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Some essential contributor guides missing"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  pr-template-validation:
    runs-on: ubuntu-latest
    needs: contributor-guide-validation
    if: needs.contributor-guide-validation.outputs.guide-status == 'success'
    outputs:
      template-status: ${{ steps.validate.outputs.status }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate PR templates
        id: validate
        run: |
          echo "üìù Validating PR templates..."

          # Check for essential PR templates
          ESSENTIAL_TEMPLATES=(
            ".github/pull_request_template.md"
            ".github/HOTFIX_TEMPLATE.md"
            ".github/SIMPLE_FIX_TEMPLATE.md"
          )

          MISSING_TEMPLATES=0
          for template in "${ESSENTIAL_TEMPLATES[@]}"; do
            if [ ! -f "$template" ]; then
              echo "‚ùå Missing template: $template"
              MISSING_TEMPLATES=1
            fi
          done

          if [ $MISSING_TEMPLATES -eq 0 ]; then
            echo "‚úÖ All essential PR templates present"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Some essential PR templates missing"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  hygiene-scripts-validation:
    runs-on: ubuntu-latest
    needs: contributor-guide-validation
    if: needs.contributor-guide-validation.outputs.guide-status == 'success' && (github.event_name == 'workflow_dispatch' && github.event.inputs.onboarding_action == 'hygiene')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate hygiene scripts
        run: |
          echo "üßπ Validating hygiene scripts..."

          # Check for essential hygiene scripts
          ESSENTIAL_SCRIPTS=(
            "pre-push-hygiene.sh"
            "validate-semantic-commits.sh"
          )

          MISSING_SCRIPTS=0
          for script in "${ESSENTIAL_SCRIPTS[@]}"; do
            if [ ! -f "$script" ]; then
              echo "‚ùå Missing script: $script"
              MISSING_SCRIPTS=1
            fi
          done

          if [ $MISSING_SCRIPTS -eq 0 ]; then
            echo "‚úÖ All essential hygiene scripts present"
            
            # Make scripts executable
            for script in "${ESSENTIAL_SCRIPTS[@]}"; do
              chmod +x "$script"
              echo "‚úÖ Made $script executable"
            done
          else
            echo "‚ùå Some essential hygiene scripts missing"
          fi

  systematic-flow-validation:
    runs-on: ubuntu-latest
    needs: contributor-guide-validation
    if: needs.contributor-guide-validation.outputs.guide-status == 'success' && (github.event_name == 'workflow_dispatch' && github.event.inputs.onboarding_action == 'flow')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate systematic flow
        run: |
          echo "üîÑ Validating systematic Push-Pull-Merge-PR flow..."

          # Check if systematic flow guide exists
          if [ -f "SYSTEMATIC_PUSH_PULL_MERGE_PR_FLOW.md" ]; then
            echo "‚úÖ Systematic flow guide found"
            
            # Check for essential flow components
            FLOW_COMPONENTS=(
              "git pull --rebase"
              "git checkout -b"
              "git commit -m"
              "git push"
              "gh pr create"
              "gh pr merge"
            )
            
            MISSING_COMPONENTS=0
            for component in "${FLOW_COMPONENTS[@]}"; do
              if ! grep -q "$component" "SYSTEMATIC_PUSH_PULL_MERGE_PR_FLOW.md"; then
                echo "‚ö†Ô∏è Missing flow component: $component"
                MISSING_COMPONENTS=1
              fi
            done
            
            if [ $MISSING_COMPONENTS -eq 0 ]; then
              echo "‚úÖ All essential flow components documented"
            else
              echo "‚ö†Ô∏è Some essential flow components may be missing"
            fi
          else
            echo "‚ùå Systematic flow guide missing"
          fi

  onboarding-test:
    runs-on: ubuntu-latest
    needs: [contributor-guide-validation, pr-template-validation]
    if: needs.contributor-guide-validation.outputs.guide-status == 'success' && needs.pr-template-validation.outputs.template-status == 'success' && (github.event_name == 'workflow_dispatch' && github.event.inputs.onboarding_action == 'test')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test onboarding process
        run: |
          echo "üß™ Testing onboarding process..."

          # Simulate new contributor onboarding
          echo "üìã Step 1: Read CONTRIBUTOR_GUIDE.md"
          if [ -f "CONTRIBUTOR_GUIDE.md" ]; then
            echo "‚úÖ CONTRIBUTOR_GUIDE.md accessible"
          fi

          echo "üìã Step 2: Set up development environment"
          if [ -f "package.json" ]; then
            echo "‚úÖ Development environment setup documented"
          fi

          echo "üìã Step 3: Follow systematic flow"
          if [ -f "SYSTEMATIC_PUSH_PULL_MERGE_PR_FLOW.md" ]; then
            echo "‚úÖ Systematic flow guide available"
          fi

          echo "üìã Step 4: Create PR using template"
          if [ -f ".github/pull_request_template.md" ]; then
            echo "‚úÖ PR template available"
          fi

          echo "üìã Step 5: Run hygiene checks"
          if [ -f "pre-push-hygiene.sh" ]; then
            echo "‚úÖ Hygiene scripts available"
          fi

          echo "‚úÖ Onboarding process test completed"

  onboarding-validation:
    runs-on: ubuntu-latest
    needs:
      [
        contributor-guide-validation,
        pr-template-validation,
        hygiene-scripts-validation,
        systematic-flow-validation,
        onboarding-test,
      ]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate onboarding setup
        run: |
          echo "üîê Validating onboarding configuration..."

          # Check if all onboarding components are present
          ONBOARDING_COMPONENTS=(
            "CONTRIBUTOR_GUIDE.md"
            "CONTRIBUTOR_ONBOARDING.md"
            "SYSTEMATIC_PUSH_PULL_MERGE_PR_FLOW.md"
            ".github/pull_request_template.md"
            ".github/HOTFIX_TEMPLATE.md"
            ".github/SIMPLE_FIX_TEMPLATE.md"
            "pre-push-hygiene.sh"
            "validate-semantic-commits.sh"
          )

          MISSING_COMPONENTS=0
          for component in "${ONBOARDING_COMPONENTS[@]}"; do
            if [ ! -f "$component" ]; then
              echo "‚ùå Missing component: $component"
              MISSING_COMPONENTS=1
            fi
          done

          if [ $MISSING_COMPONENTS -eq 0 ]; then
            echo "‚úÖ All onboarding components present"
          else
            echo "‚ùå Some onboarding components missing"
          fi

          # Check onboarding coverage
          GUIDE_SECTIONS=$(grep -c "^#" CONTRIBUTOR_GUIDE.md)
          FLOW_STEPS=$(grep -c "^##" SYSTEMATIC_PUSH_PULL_MERGE_PR_FLOW.md)

          echo "üìä Onboarding coverage:"
          echo "- Guide sections: $GUIDE_SECTIONS"
          echo "- Flow steps: $FLOW_STEPS"

  notification:
    runs-on: ubuntu-latest
    needs:
      [
        contributor-guide-validation,
        pr-template-validation,
        hygiene-scripts-validation,
        systematic-flow-validation,
        onboarding-test,
        onboarding-validation,
      ]
    if: always()
    steps:
      - name: Send onboarding notification
        run: |
          echo "üì¢ Sending onboarding notification..."

          # Check if Slack webhook URL is available
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            ACTION="${{ github.event.inputs.onboarding_action || 'validate' }}"
            
            if [ "${{ needs.contributor-guide-validation.outputs.guide-status }}" = "success" ] &&
               [ "${{ needs.pr-template-validation.outputs.template-status }}" = "success" ] &&
               [ "${{ needs.onboarding-validation.result }}" = "success" ]; then
              if [ "$ACTION" = "validate" ]; then
                MESSAGE="üìö Onboarding validation completed! ‚úÖ Contributor guides and templates validated"
              elif [ "$ACTION" = "templates" ]; then
                MESSAGE="üìù PR templates validated! ‚úÖ All templates configured and ready"
              elif [ "$ACTION" = "hygiene" ]; then
                MESSAGE="üßπ Hygiene scripts validated! ‚úÖ All hygiene scripts configured"
              elif [ "$ACTION" = "flow" ]; then
                MESSAGE="üîÑ Systematic flow validated! ‚úÖ Push-Pull-Merge-PR flow documented"
              elif [ "$ACTION" = "test" ]; then
                MESSAGE="üß™ Onboarding test completed! ‚úÖ Onboarding process validated"
              fi
            else
              MESSAGE="‚ö†Ô∏è Onboarding operation completed with issues. Please review the logs for details."
            fi
            
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H 'Content-type: application/json' \
              -d "{\"text\":\"$MESSAGE\"}" \
              --max-time 30
          else
            echo "üì¢ Slack webhook URL not configured, skipping notification"
          fi
