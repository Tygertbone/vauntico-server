name: MCP Monitoring Connector

on:
  workflow_dispatch:
    inputs:
      monitoring_action:
        description: "Monitoring Action"
        required: true
        default: "validate"
        type: choice
        options:
          - validate
          - alerts
          - dashboards
          - slo
          - health
  push:
    branches: [main]
    paths:
      - "monitoring/**"
      - ".github/workflows/monitoring*"
  schedule:
    - cron: "0 * * * *" # Hourly monitoring check

jobs:
  prometheus-validation:
    runs-on: ubuntu-latest
    outputs:
      prometheus-status: ${{ steps.validate.outputs.status }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Prometheus configuration
        id: validate
        run: |
          echo "üîç Validating Prometheus configuration..."

          # Check if Prometheus config exists
          if [ -f "monitoring/prometheus.yml" ]; then
            echo "‚úÖ Prometheus configuration found"
            
            # Validate YAML syntax
            if python3 -c "import yaml; yaml.safe_load(open('monitoring/prometheus.yml'))"; then
              echo "‚úÖ Prometheus YAML is valid"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Prometheus YAML has syntax errors"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            # Check for essential scrape configs
            if grep -q "scrape_configs:" monitoring/prometheus.yml; then
              echo "‚úÖ Scrape configs present"
            else
              echo "‚ùå Scrape configs missing"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "‚ùå Prometheus configuration missing"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  alert-rules-validation:
    runs-on: ubuntu-latest
    needs: prometheus-validation
    if: needs.prometheus-validation.outputs.prometheus-status == 'success'
    outputs:
      alert-rules-status: ${{ steps.validate.outputs.status }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate alert rules
        id: validate
        run: |
          echo "üîî Validating alert rules..."

          # Check if alert rules exist
          if [ -f "monitoring/alert_rules.yml" ]; then
            echo "‚úÖ Alert rules found"
            
            # Validate YAML syntax
            if python3 -c "import yaml; yaml.safe_load(open('monitoring/alert_rules.yml'))"; then
              echo "‚úÖ Alert rules YAML is valid"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Alert rules YAML has syntax errors"
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            # Count alert rules
            ALERT_COUNT=$(grep -c "alert:" monitoring/alert_rules.yml)
            echo "üîî Found $ALERT_COUNT alert rules"
            
            if [ $ALERT_COUNT -gt 0 ]; then
              echo "‚úÖ Alert rules configured"
            else
              echo "‚ö†Ô∏è No alert rules configured"
            fi
          else
            echo "‚ùå Alert rules missing"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  grafana-dashboards-validation:
    runs-on: ubuntu-latest
    needs: prometheus-validation
    if: needs.prometheus-validation.outputs.prometheus-status == 'success' && (github.event_name == 'workflow_dispatch' && github.event.inputs.monitoring_action == 'dashboards')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Grafana dashboards
        run: |
          echo "üìä Validating Grafana dashboards..."

          # Check if Grafana directory exists
          if [ -d "monitoring/grafana" ]; then
            echo "‚úÖ Grafana directory found"
            
            # Check for dashboards
            if [ -d "monitoring/grafana/dashboards" ]; then
              DASHBOARD_COUNT=$(find monitoring/grafana/dashboards -name "*.json" | wc -l)
              echo "üìä Found $DASHBOARD_COUNT dashboards"
              
              if [ $DASHBOARD_COUNT -gt 0 ]; then
                echo "‚úÖ Grafana dashboards configured"
                
                # List dashboards
                echo "üìã Available dashboards:"
                find monitoring/grafana/dashboards -name "*.json" -exec basename {} \;
              else
                echo "‚ö†Ô∏è No Grafana dashboards found"
              fi
            else
              echo "‚ö†Ô∏è Grafana dashboards directory missing"
            fi
            
            # Check for provisioning
            if [ -d "monitoring/grafana/provisioning" ]; then
              echo "‚úÖ Grafana provisioning configured"
            else
              echo "‚ö†Ô∏è Grafana provisioning directory missing"
            fi
          else
            echo "‚ùå Grafana directory missing"
          fi

  slo-validation:
    runs-on: ubuntu-latest
    needs: prometheus-validation
    if: needs.prometheus-validation.outputs.prometheus-status == 'success' && (github.event_name == 'workflow_dispatch' && github.event.inputs.monitoring_action == 'slo')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate SLO configuration
        run: |
          echo "üéØ Validating SLO configuration..."

          # Check Prometheus for SLO-related metrics
          if grep -q "slo" monitoring/prometheus.yml; then
            echo "‚úÖ SLO metrics configured in Prometheus"
          else
            echo "‚ö†Ô∏è No SLO metrics found in Prometheus"
          fi

          # Check alert rules for SLO alerts
          if grep -q "slo" monitoring/alert_rules.yml; then
            echo "‚úÖ SLO alerts configured"
          else
            echo "‚ö†Ô∏è No SLO alerts found"
          fi

          echo "üìä SLO validation completed"
          echo "üéØ Target SLOs:"
          echo "- Availability: 99.95%"
          echo "- Latency: <200ms"
          echo "- Error Rate: <1%"

  monitoring-health-check:
    runs-on: ubuntu-latest
    needs: [prometheus-validation, alert-rules-validation]
    if: needs.prometheus-validation.outputs.prometheus-status == 'success' && needs.alert-rules-validation.outputs.alert-rules-status == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check monitoring health
        run: |
          echo "ü©∫ Checking monitoring health..."

          # Check if monitoring services are configured
          MONITORING_SERVICES=(
            "prometheus"
            "grafana"
            "alertmanager"
          )

          for service in "${MONITORING_SERVICES[@]}"; do
            if grep -qr "$service" monitoring/; then
              echo "‚úÖ $service configured"
            else
              echo "‚ö†Ô∏è $service not found in monitoring configuration"
            fi
          done

          # Check scrape targets
          SCRAPE_TARGETS=$(grep -A 5 "scrape_configs:" monitoring/prometheus.yml | grep -c "job_name:")
          echo "üéØ Found $SCRAPE_TARGETS scrape targets"

          if [ $SCRAPE_TARGETS -gt 0 ]; then
            echo "‚úÖ Monitoring targets configured"
          else
            echo "‚ùå No monitoring targets configured"
          fi

  monitoring-alerts:
    runs-on: ubuntu-latest
    needs: alert-rules-validation
    if: needs.alert-rules-validation.outputs.alert-rules-status == 'success' && (github.event_name == 'workflow_dispatch' && github.event.inputs.monitoring_action == 'alerts')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check monitoring alerts
        run: |
          echo "üîî Checking monitoring alerts..."

          # List all configured alerts
          echo "üìã Configured alerts:"
          grep "alert:" monitoring/alert_rules.yml | sed 's/alert: //'

          # Check for critical alerts
          CRITICAL_ALERTS=$(grep -A 5 "severity: critical" monitoring/alert_rules.yml | grep "alert:" | sed 's/alert: //')
          if [ -n "$CRITICAL_ALERTS" ]; then
            echo "‚ö†Ô∏è Critical alerts configured:"
            echo "$CRITICAL_ALERTS"
          fi

          # Check for warning alerts
          WARNING_ALERTS=$(grep -A 5 "severity: warning" monitoring/alert_rules.yml | grep "alert:" | sed 's/alert: //')
          if [ -n "$WARNING_ALERTS" ]; then
            echo "‚ö†Ô∏è Warning alerts configured:"
            echo "$WARNING_ALERTS"
          fi

  monitoring-validation:
    runs-on: ubuntu-latest
    needs:
      [
        prometheus-validation,
        alert-rules-validation,
        grafana-dashboards-validation,
        slo-validation,
        monitoring-health-check,
        monitoring-alerts,
      ]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate monitoring setup
        run: |
          echo "üîê Validating monitoring configuration..."

          # Check if all monitoring components are present
          MONITORING_COMPONENTS=(
            "prometheus.yml"
            "alert_rules.yml"
            "grafana/dashboards"
            "grafana/provisioning"
          )

          MISSING_COMPONENTS=0
          for component in "${MONITORING_COMPONENTS[@]}"; do
            if [ ! -e "monitoring/$component" ]; then
              echo "‚ùå Missing component: $component"
              MISSING_COMPONENTS=1
            fi
          done

          if [ $MISSING_COMPONENTS -eq 0 ]; then
            echo "‚úÖ All monitoring components present"
          else
            echo "‚ùå Some monitoring components missing"
          fi

          # Check monitoring coverage
          SCRAPE_JOBS=$(grep "job_name:" monitoring/prometheus.yml | wc -l)
          ALERT_RULES=$(grep "alert:" monitoring/alert_rules.yml | wc -l)
          DASHBOARDS=$(find monitoring/grafana/dashboards -name "*.json" | wc -l)

          echo "üìä Monitoring coverage:"
          echo "- Scrape jobs: $SCRAPE_JOBS"
          echo "- Alert rules: $ALERT_RULES"
          echo "- Dashboards: $DASHBOARDS"

  notification:
    runs-on: ubuntu-latest
    needs:
      [
        prometheus-validation,
        alert-rules-validation,
        grafana-dashboards-validation,
        slo-validation,
        monitoring-health-check,
        monitoring-alerts,
        monitoring-validation,
      ]
    if: always()
    steps:
      - name: Send monitoring notification
        run: |
          echo "üì¢ Sending monitoring notification..."

          # Check if Slack webhook URL is available
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            ACTION="${{ github.event.inputs.monitoring_action || 'validate' }}"
            
            if [ "${{ needs.prometheus-validation.outputs.prometheus-status }}" = "success" ] &&
               [ "${{ needs.alert-rules-validation.outputs.alert-rules-status }}" = "success" ] &&
               [ "${{ needs.monitoring-validation.result }}" = "success" ]; then
              if [ "$ACTION" = "validate" ]; then
                MESSAGE="üîê Monitoring validation completed! ‚úÖ Prometheus and alert rules validated"
              elif [ "$ACTION" = "alerts" ]; then
                MESSAGE="üîî Monitoring alerts checked! ‚úÖ Alert rules configured and validated"
              elif [ "$ACTION" = "dashboards" ]; then
                MESSAGE="üìä Grafana dashboards validated! ‚úÖ Dashboards configured and ready"
              elif [ "$ACTION" = "slo" ]; then
                MESSAGE="üéØ SLO validation completed! ‚úÖ Service Level Objectives configured"
              elif [ "$ACTION" = "health" ]; then
                MESSAGE="ü©∫ Monitoring health check passed! ‚úÖ All monitoring services healthy"
              fi
            else
              MESSAGE="‚ö†Ô∏è Monitoring operation completed with issues. Please review the logs for details."
            fi
            
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H 'Content-type: application/json' \
              -d "{\"text\":\"$MESSAGE\"}" \
              --max-time 30
          else
            echo "üì¢ Slack webhook URL not configured, skipping notification"
          fi
