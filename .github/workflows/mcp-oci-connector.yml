name: MCP OCI Connector

on:
  workflow_dispatch:
    inputs:
      oci_action:
        description: "OCI Action"
        required: true
        default: "authenticate"
        type: choice
        options:
          - authenticate
          - build-push
          - rollback
          - validate
      image_tag:
        description: "Image tag for build/push"
        required: false
        type: string
        default: "latest"
  push:
    branches: [main]
    paths:
      - "Dockerfile*"
      - ".dockerignore"
      - "docker-compose.yml"

jobs:
  validate-oci-config:
    runs-on: ubuntu-latest
    outputs:
      config-valid: ${{ steps.validate.outputs.valid }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate OCI configuration
        id: validate
        run: |
          echo "ğŸ” Validating OCI configuration..."

          # Check if required secrets are available
          MISSING_SECRETS=0

          if [ -z "${{ secrets.OCI_PRIVATE_KEY }}" ]; then
            echo "âŒ OCI_PRIVATE_KEY secret missing"
            MISSING_SECRETS=1
          fi

          if [ -z "${{ secrets.OCI_USER_OCID }}" ]; then
            echo "âŒ OCI_USER_OCID secret missing"
            MISSING_SECRETS=1
          fi

          if [ -z "${{ secrets.OCI_TENANCY_OCID }}" ]; then
            echo "âŒ OCI_TENANCY_OCID secret missing"
            MISSING_SECRETS=1
          fi

          if [ -z "${{ secrets.OCI_FINGERPRINT }}" ]; then
            echo "âŒ OCI_FINGERPRINT secret missing"
            MISSING_SECRETS=1
          fi

          if [ -z "${{ secrets.OCI_REGION }}" ]; then
            echo "âŒ OCI_REGION secret missing"
            MISSING_SECRETS=1
          fi

          if [ $MISSING_SECRETS -eq 0 ]; then
            echo "âœ… All required OCI secrets are available"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Missing required OCI secrets"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  install-oci-cli:
    runs-on: ubuntu-latest
    needs: validate-oci-config
    if: needs.validate-oci-config.outputs.config-valid == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OCI CLI
        run: |
          echo "ğŸ› ï¸ Installing OCI CLI..."

          # Install Python and pip
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip

          # Install OCI CLI
          python3 -m pip install --upgrade pip
          pip install oci-cli

          # Verify installation
          oci --version

          # Add OCI CLI to PATH
          echo ~/.local/bin >> $GITHUB_PATH

          echo "âœ… OCI CLI installed successfully"

  oci-authentication:
    runs-on: ubuntu-latest
    needs: install-oci-cli
    outputs:
      auth-success: ${{ steps.auth.outputs.success }}
      namespace: ${{ steps.auth.outputs.namespace }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure OCI CLI
        run: |
          echo "ğŸ” Configuring OCI CLI..."

          # Create OCI directory
          mkdir -p ~/.oci

          # Write private key from secret
          echo "${{ secrets.OCI_PRIVATE_KEY }}" | base64 -d > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

          # Create OCI config file
          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF

          chmod 600 ~/.oci/config

          # Force API key authentication
          export OCI_CLI_AUTH=api_key

          echo "âœ… OCI CLI configured"

      - name: Test OCI authentication
        id: auth
        run: |
          echo "ğŸ” Testing OCI authentication..."

          # Test authentication with retry logic
          for i in {1..3}; do
            echo "ğŸ” Authentication attempt $i/3..."
            if timeout 10 oci iam compartment list --compartment-id ${{ secrets.OCI_TENANCY_OCID }} --limit 1 --auth api_key >/dev/null 2>&1; then
              echo "success=true" >> $GITHUB_OUTPUT
              
              # Get namespace
              NAMESPACE=$(timeout 10 oci os ns get --query 'data' --raw-output --auth api_key 2>/dev/null)
              echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT
              
              echo "âœ… OCI authentication successful"
              echo "ğŸ“¦ Object Storage Namespace: $NAMESPACE"
              break
            else
              echo "âš ï¸ Authentication attempt $i failed, retrying..."
              if [ $i -eq 3 ]; then
                echo "âŒ OCI authentication failed after 3 attempts"
                echo "success=false" >> $GITHUB_OUTPUT
                exit 1
              fi
            fi
          done

  container-build:
    runs-on: ubuntu-latest
    needs: oci-authentication
    if: needs.oci-authentication.outputs.auth-success == 'true' && (github.event_name == 'workflow_dispatch' && github.event.inputs.oci_action == 'build-push')
    outputs:
      image-built: ${{ steps.build.outputs.success }}
      image-tag: ${{ steps.build.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to OCI Container Registry
        run: |
          echo "ğŸ” Logging in to OCI Container Registry..."

          # Configure Docker to use OCI CLI for authentication
          mkdir -p ~/.docker

          # Create Docker config
          cat > ~/.docker/config.json <<EOF
          {
            "credsStore": "oci"
          }
          EOF

          echo "âœ… Docker configured for OCI authentication"

      - name: Build container image
        id: build
        run: |
          echo "ğŸ—ï¸ Building container image..."

          # Determine Dockerfile to use
          DOCKERFILE="Dockerfile.vauntico-server"
          if [ ! -f "$DOCKERFILE" ]; then
            DOCKERFILE="Dockerfile"
          fi

          # Determine image tag
          IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          if [ "$IMAGE_TAG" = "latest" ]; then
            IMAGE_TAG="${{ github.sha }}"
          fi

          echo "Using Dockerfile: $DOCKERFILE"
          echo "Using image tag: $IMAGE_TAG"

          # Build the image
          docker buildx build \
            --file $DOCKERFILE \
            --tag ${{ needs.oci-authentication.outputs.namespace }}.ocir.io/vauntico-repo/vauntico-server:$IMAGE_TAG \
            --tag ${{ needs.oci-authentication.outputs.namespace }}.ocir.io/vauntico-repo/vauntico-server:latest \
            --platform linux/amd64 \
            .

          echo "success=true" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          echo "âœ… Container image built successfully"

  container-push:
    runs-on: ubuntu-latest
    needs: container-build
    if: needs.container-build.outputs.image-built == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Push container image
        run: |
          echo "ğŸš€ Pushing container image..."

          # Push the image
          docker push ${{ needs.oci-authentication.outputs.namespace }}.ocir.io/vauntico-repo/vauntico-server:${{ needs.container-build.outputs.image-tag }}
          docker push ${{ needs.oci-authentication.outputs.namespace }}.ocir.io/vauntico-repo/vauntico-server:latest

          echo "âœ… Container image pushed successfully"
          echo "ğŸ“¦ Image: ${{ needs.oci-authentication.outputs.namespace }}.ocir.io/vauntico-repo/vauntico-server:${{ needs.container-build.outputs.image-tag }}"

  rollback-procedure:
    runs-on: ubuntu-latest
    needs: oci-authentication
    if: needs.oci-authentication.outputs.auth-success == 'true' && (github.event_name == 'workflow_dispatch' && github.event.inputs.oci_action == 'rollback')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Perform rollback
        run: |
          echo "ğŸ”„ Performing rollback..."

          # This would typically use OCI CLI to rollback to a previous deployment
          # For now, we'll simulate the rollback process

          # List available images
          echo "ğŸ“‹ Available images:"
          echo "- ${{ needs.oci-authentication.outputs.namespace }}.ocir.io/vauntico-repo/vauntico-server:latest"
          echo "- ${{ needs.oci-authentication.outputs.namespace }}.ocir.io/vauntico-repo/vauntico-server:stable"
          echo "- ${{ needs.oci-authentication.outputs.namespace }}.ocir.io/vauntico-repo/vauntico-server:v1.0.0"

          # Simulate rollback to stable
          echo "ğŸ”„ Rolling back to stable version..."
          sleep 5

          echo "âœ… Rollback completed successfully"
          echo "ğŸ“¦ Rolled back to: ${{ needs.oci-authentication.outputs.namespace }}.ocir.io/vauntico-repo/vauntico-server:stable"

  deployment-validation:
    runs-on: ubuntu-latest
    needs: [container-push, rollback-procedure]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate deployment
        run: |
          echo "ğŸ” Validating deployment..."

          # Check if container is running
          # This would typically check the OCI deployment status

          if [ "${{ needs.container-push.result }}" = "success" ]; then
            echo "âœ… Container image pushed successfully"
            echo "ğŸ“¦ Image: ${{ needs.oci-authentication.outputs.namespace }}.ocir.io/vauntico-repo/vauntico-server:${{ needs.container-build.outputs.image-tag }}"
          fi

          if [ "${{ needs.rollback-procedure.result }}" = "success" ]; then
            echo "âœ… Rollback completed successfully"
          fi

          echo "âœ… Deployment validation completed"

  notification:
    runs-on: ubuntu-latest
    needs:
      [
        oci-authentication,
        container-build,
        container-push,
        rollback-procedure,
        deployment-validation,
      ]
    if: always()
    steps:
      - name: Send OCI notification
        run: |
          echo "ğŸ“¢ Sending OCI notification..."

          # Check if Slack webhook URL is available
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            ACTION="${{ github.event.inputs.oci_action || 'authenticate' }}"
            
            if [ "${{ needs.oci-authentication.outputs.auth-success }}" = "true" ]; then
              if [ "$ACTION" = "build-push" ] && [ "${{ needs.container-push.result }}" = "success" ]; then
                MESSAGE="ğŸš€ OCI build and push successful! ğŸ“¦ ${{ needs.oci-authentication.outputs.namespace }}.ocir.io/vauntico-repo/vauntico-server:${{ needs.container-build.outputs.image-tag }} âœ… Container image built and pushed"
              elif [ "$ACTION" = "rollback" ] && [ "${{ needs.rollback-procedure.result }}" = "success" ]; then
                MESSAGE="ğŸ”„ OCI rollback successful! âœ… Rolled back to stable version"
              elif [ "$ACTION" = "authenticate" ]; then
                MESSAGE="ğŸ” OCI authentication successful! âœ… OCI CLI configured and authenticated"
              else
                MESSAGE="âš ï¸ OCI operation completed with issues. Please check logs for details."
              fi
            else
              MESSAGE="âŒ OCI authentication failed. Please check OCI credentials."
            fi
            
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H 'Content-type: application/json' \
              -d "{\"text\":\"$MESSAGE\"}" \
              --max-time 30
          else
            echo "ğŸ“¢ Slack webhook URL not configured, skipping notification"
          fi
