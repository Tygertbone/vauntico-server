name: Governance and KPI Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, "feature/*", "hotfix/*"]

jobs:
  governance-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR Template Compliance
        run: |
          echo "ðŸ” Validating PR governance compliance..."

          # Check if PR has monetization phase selected
          if [[ "${{ github.event.pull_request.body }}" != *"Phase 1: Foundation"* ]] && \
             [[ "${{ github.event.pull_request.body }}" != *"Phase 2: B2B API Licensing"* ]] && \
             [[ "${{ github.event.pull_request.body }}" != *"Phase 3: Enterprise Compliance"* ]] && \
             [[ "${{ github.event.pull_request.body }}" != *"Phase 4: Creator Economy"* ]] && \
             [[ "${{ github.event.pull_request.body }}" != *"Phase 5: Vauntico Credits"* ]]; then
            echo "âŒ PR missing monetization phase selection"
            echo "::error::PR must specify monetization phase"
            exit 1
          fi

          # Check if PR has revenue target specified
          if [[ "${{ github.event.pull_request.body }}" != *"Revenue Target:"* ]]; then
            echo "âŒ PR missing revenue target specification"
            echo "::error::PR must specify revenue target from memories.md"
            exit 1
          fi

          # Check if PR references memories.md
          if [[ "${{ github.event.pull_request.body }}" != *"memories.md"* ]]; then
            echo "âŒ PR missing memories.md reference"
            echo "::error::PR must reference memories.md section"
            exit 1
          fi

          echo "âœ… PR template validation passed"

      - name: Validate Commit Convention Compliance
        run: |
          echo "ðŸ” Validating commit convention compliance..."

          # Get recent commits for this PR
          COMMITS=$(git log --oneline --since="${{ github.event.pull_request.base.sha }}" --format="%s")

          # Check each commit for proper format
          while IFS= read -r commit; do
            if [[ ! "$commit" =~ ^(Phase [1-5]): (feat|fix|docs|style|refactor|test|chore): .+ ]]; then
              echo "âŒ Invalid commit format: $commit"
              echo "::error::Commit must follow 'phase: type: description' format"
              exit 1
            fi
          done

          echo "âœ… Commit convention validation passed"

      - name: Validate KPI Impact Assessment
        run: |
          echo "ðŸ” Validating KPI impact assessment..."

          # Check if PR specifies KPI metrics affected
          if [[ "${{ github.event.pull_request.body }}" != *"pro_subscriptions"* ]] && \
             [[ "${{ github.event.pull_request.body }}" != *"score_insurance_signups"* ]] && \
             [[ "${{ github.event.pull_request.body }}" != *"trust_calculator_usage"* ]]; then
            echo "âš ï¸ PR should specify KPI metrics affected"
            echo "::warning::Consider specifying which KPIs are affected by this change"
          fi

          echo "âœ… KPI impact assessment validated"

  kpi-tracking-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: governance-validation
    if: github.event_name == 'pull_request'
    steps:
      - name: Validate KPI Implementation
        run: |
          echo "ðŸ” Validating KPI implementation..."

          # Check for Phase 1 KPI endpoints in code
          KPI_ENDPOINTS_FOUND=true

          # Check for pro subscriptions tracking
          if grep -r "pro_subscriptions" server-v2/src/ --include="*.ts,*.js,*.tsx" >/dev/null; then
            echo "âœ… Pro subscriptions tracking found"
          else
            echo "âš ï¸ Pro subscriptions tracking not found"
            KPI_ENDPOINTS_FOUND=false
          fi

          # Check for score insurance signups
          if grep -r "score_insurance_signups" server-v2/src/ --include="*.ts,*.js,*.tsx" >/dev/null; then
            echo "âœ… Score insurance signups tracking found"
          else
            echo "âš ï¸ Score insurance signups tracking not found"
            KPI_ENDPOINTS_FOUND=false
          fi

          # Check for trust calculator usage
          if grep -r "trust_calculator_usage" server-v2/src/ --include="*.ts,*.js,*.tsx" >/dev/null; then
            echo "âœ… Trust calculator usage tracking found"
          else
            echo "âš ï¸ Trust calculator usage tracking not found"
            KPI_ENDPOINTS_FOUND=false
          fi

          if [ "$KPI_ENDPOINTS_FOUND" = true ]; then
            echo "âœ… KPI implementation validation passed"
          else
            echo "::warning::Some KPI endpoints may be missing"
          fi

  blind-spot-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: governance-validation
    steps:
      - name: Validate Blind Spot Mitigations
        run: |
          echo "ðŸ” Validating blind spot mitigations..."

          # Check for data privacy mitigations
          PRIVACY_MITIGATIONS_FOUND=true
          if ! grep -r "data_privacy" server-v2/src/ --include="*.ts,*.js,*.tsx" >/dev/null; then
            echo "âš ï¸ Data privacy mitigations not found"
            PRIVACY_MITIGATIONS_FOUND=false
          fi

          # Check for platform dependency mitigations
          PLATFORM_MITIGATIONS_FOUND=true
          if ! grep -r "platform_dependency" server-v2/src/ --include="*.ts,*.js,*.tsx" >/dev/null; then
            echo "âš ï¸ Platform dependency mitigations not found"
            PLATFORM_MITIGATIONS_FOUND=false
          fi

          # Check for algorithm gaming mitigations
          GAMING_MITIGATIONS_FOUND=true
          if ! grep -r "algorithm_gaming" server-v2/src/ --include="*.ts,*.js,*.tsx" >/dev/null; then
            echo "âš ï¸ Algorithm gaming mitigations not found"
            GAMING_MITIGATIONS_FOUND=false
          fi

          # Check for commoditization mitigations
          COMMODITIZATION_MITIGATIONS_FOUND=true
          if ! grep -r "commoditization" server-v2/src/ --include="*.ts,*.js,*.tsx" >/dev/null; then
            echo "âš ï¸ Commoditization mitigations not found"
            COMMODITIZATION_MITIGATIONS_FOUND=false
          fi

          if [ "$PRIVACY_MITIGATIONS_FOUND" = true ] && \
             [ "$PLATFORM_MITIGATIONS_FOUND" = true ] && \
             [ "$GAMING_MITIGATIONS_FOUND" = true ] && \
             [ "$COMMODITIZATION_MITIGATIONS_FOUND" = true ]; then
            echo "âœ… Blind spot mitigations validation passed"
          else
            echo "::warning::Some blind spot mitigations may be missing"
          fi

  deployment-tracking:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: governance-validation
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Track Deployment Metrics
        run: |
          echo "ðŸ“Š Tracking deployment metrics..."

          # Extract deployment information
          DEPLOYMENT_ID="deploy-$(date +%Y%m%d-%H%M%S)-${{ github.sha }}"
          MONETIZATION_PHASE="Phase 1: Foundation"
          REVENUE_TARGET="100K MRR from creators"

          # Create deployment tracking payload
          cat > deployment-payload.json <<EOF
          {
            "deployment_id": "$DEPLOYMENT_ID",
            "monetization_phase": "$MONETIZATION_PHASE",
            "feature_description": "Automated deployment",
            "phase_target": "$REVENUE_TARGET",
            "kpi_metrics": "pro_subscriptions,score_insurance_signups,trust_calculator_usage",
            "blind_spots": "data_privacy,platform_dependency",
            "deployment_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "github_sha": "${{ github.sha }}",
            "github_ref": "${{ github.ref }}",
            "github_actor": "${{ github.actor }}"
          }
          EOF

          echo "ðŸ“‹ Deployment tracking payload created"
          cat deployment-payload.json

          # In a real implementation, this would be sent to monitoring system
          echo "âœ… Deployment metrics tracked"
